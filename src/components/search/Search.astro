---
// Importación de utilidades de internalización (i18n)
// (getTils/getBlogPosts ya no son necesarios aquí, están en el componente unificado)

import SearchIcon from '../../icons/search.svg'
import CloseIcon from '../../icons/close.svg'
import SearchResults from './SearchResults.astro'

// Definición de las Props del componente
interface Props {
	lang: 'es' | 'en' | 'ca'
}

const { lang = 'es' } = Astro.props
// const t = useTranslations(lang) // Ya no se usa directamente aquí
---

<!-- Modal de búsqueda para dispositivos móviles (y desktop overlay) -->
<div id="search-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
	<!-- Fondo Oscuro / Backdrop con efecto blur -->
	<div
		class="fixed inset-0 bg-zinc-900/30 opacity-0 backdrop-blur-sm transition-opacity duration-300"
		id="search-backdrop"
	>
	</div>

	<!-- Panel del Modal:
         Mobile: Top-anchored, 90vh height (h-[90vh]), padding bottom implied by height not being 100%.
         Desktop (sm+): Centered/Top padding standard behavior.
    -->
	<div
		class="pointer-events-none fixed inset-0 z-10 flex flex-col items-center justify-start p-0 sm:p-6 md:p-20"
	>
		<!-- Contenedor del modal móvil -->
		<div
			id="search-panel"
			class="pointer-events-auto flex h-[70vh] w-full -translate-y-4 flex-col overflow-hidden rounded-b-2xl bg-white opacity-0 shadow-2xl ring-1 ring-black/5 transition-all duration-300 ease-out dark:bg-zinc-900 sm:mx-auto sm:h-auto sm:max-h-[80vh] sm:max-w-5xl sm:rounded-xl"
		>
			<!-- Campo de Búsqueda (Input) + Botón Cerrar -->
			<div
				class="relative flex shrink-0 items-center border-b border-zinc-100 dark:border-zinc-800"
			>
				<SearchIcon class="pointer-events-none absolute left-4 size-5 text-zinc-400" />
				<input
					id="mobile-search-input"
					type="text"
					class="h-14 w-full border-0 bg-transparent pl-11 pr-12 text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-0 dark:text-white sm:h-12 sm:text-sm"
					placeholder="Buscar..."
					role="combobox"
					aria-expanded="false"
					aria-controls="mobile-search-results"
				/>
				<!-- Botón Cerrar (Mobile visible) -->
				<button
					id="close-search-btn"
					class="absolute right-4 p-1 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200"
				>
					<CloseIcon class="size-5" />
				</button>
			</div>

			<!-- Componente Unificado de Resultados -->
			<SearchResults
				lang={lang}
				mode="mobile"
				inputId="mobile-search-input"
				resultsContainerId="mobile-search-results"
			/>
		</div>
	</div>
</div>

<script>
	// --- LÓGICA DEL CLIENTE (Solo Modal) ---

	// Referencias a elementos del DOM
	const modal = document.getElementById('search-modal')
	const backdrop = document.getElementById('search-backdrop')
	const panel = document.getElementById('search-panel')
	const input = modal?.querySelector('input')
	const closeBtn = document.getElementById('close-search-btn')

	// Variable para guardar el elemento que tenía el foco antes de abrir
	let lastFocusedElement: HTMLElement | null = null

	// Función para ABRIR el buscador
	function openSearch() {
		lastFocusedElement = document.activeElement as HTMLElement
		modal?.classList.remove('hidden')
		document.body.classList.add('overflow-hidden') // Bloquear scroll

		// Animación de entrada
		requestAnimationFrame(() => {
			backdrop?.classList.remove('opacity-0')
			panel?.classList.remove('opacity-0', '-translate-y-4')
		})

		// Dar foco al input tras una pequeña espera para asegurar que es visible/interactuable
		setTimeout(() => {
			input?.focus()
		}, 50)

		// La carga de Pagefind ahora la maneja UnifiedSearchResults al hacer focus
	}

	// Función para CERRAR el buscador
	function closeSearch() {
		// Animación de salida
		backdrop?.classList.add('opacity-0')
		panel?.classList.add('opacity-0', '-translate-y-4')

		document.body.classList.remove('overflow-hidden') // Desbloquear scroll

		// Esperar a que termine la transición (300ms) antes de ocultar
		setTimeout(() => {
			modal?.classList.add('hidden')
			// Limpiar input al cerrar? Opcional
			if (input) input.value = ''

			// Restaurar foco
			if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
				lastFocusedElement.focus()
			}
		}, 300)
	}

	// Listener del botón cerrar
	closeBtn?.addEventListener('click', closeSearch)

	// Event Listeners Globales: Cerrar con ESC
	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			// Si el modal está visible, cerrarlo
			if (!modal?.classList.contains('hidden')) {
				closeSearch()
			}
		}
	})

	// Cerrar al hacer clic en el backdrop
	backdrop?.addEventListener('click', closeSearch)

	// Cerrar al hacer clic fuera del contenido del modal
	const wrapper = modal?.querySelector('.fixed.z-10')
	wrapper?.addEventListener('click', (e) => {
		if (e.target === wrapper) {
			closeSearch()
		}
	})

	// FOCUS TRAP (Mantener foco dentro del modal)
	modal?.addEventListener('keydown', (e) => {
		if (e.key !== 'Tab') return

		const focusableElements = modal.querySelectorAll(
			'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])',
		)

		if (focusableElements.length === 0) return

		const firstElement = focusableElements[0] as HTMLElement
		const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement

		// Shift + Tab (hacia atrás)
		if (e.shiftKey) {
			if (document.activeElement === firstElement) {
				e.preventDefault()
				lastElement.focus()
			}
		}
		// Tab normal (hacia adelante)
		else {
			if (document.activeElement === lastElement) {
				e.preventDefault()
				firstElement.focus()
			}
		}
	})

	// Evento Personalizado: Permite abrir el buscador desde otros componentes (ej: Navbar)
	document.addEventListener('open-search', openSearch)
</script>
