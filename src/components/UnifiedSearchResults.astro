---
import { useTranslations } from '../i18n/utils'
import { getTils } from '../utils/til-content'
import { getBlogPosts } from '../utils/blog-content'
import { getProjects } from '../utils/project-content'
import { getLangFromSlug, getBaseSlug } from '../utils/blogi18n'

import PinIcon from '../icons/pin.svg?raw'
import BookmarkIcon from '../icons/bookmark.svg?raw'
import RocketIcon from '../icons/rocket.svg?raw'
import ArrowUpRightIcon from '../icons/arrow-up-right.svg?raw'

interface Props {
	lang: 'es' | 'en' | 'ca'
	mode: 'mobile' | 'desktop'
	inputId: string // ID del input externo (Modal o SearchBadges)
	resultsContainerId?: string // ID opcional para el contenedor
}

const { lang = 'es', mode, inputId, resultsContainerId = 'unified-results-container' } = Astro.props
const t = useTranslations(lang)

// --- LÓGICA DEL SERVIDOR (Build Time) ---
const allTils = await getTils()
const allBlog = (await getBlogPosts()).filter(p =>
	import.meta.env.PROD ? p.data.draft !== true : true,
)
const allProjects = await getProjects()

const recentBlog = allBlog
	.filter(p => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 12) // Initial Limit for Blog

// Resultados por defecto
const recentTils = allTils
	.filter(p => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 12) // Initial Limit for TILs

const recentProjects = allProjects
	.filter(p => p.data.lang === lang)
	.sort((a, b) => (b.data.pubDate?.valueOf() || 0) - (a.data.pubDate?.valueOf() || 0))
	.slice(0, 12) // Initial Limit for Projects

// Logic from Nav.astro to deduplicate series
const recentPosts = allBlog
	.filter(p => getLangFromSlug(p.slug) === lang && p.data.pubDate)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.reduce(
		(acc, post) => {
			if (acc.length >= 12) return acc // Limit increased to 12
			const isSeries = post.data.series
			if (isSeries) {
				// Si es parte de una serie, verificar si ya añadimos uno de esa serie
				const seriesExists = acc.some(p => p.data.series === isSeries)
				if (!seriesExists) {
					// Encontrar el primer post de la serie (Head)
					// Buscamos en 'allBlog' (que ya tiene todos los posts filtrados por draft)
					// Filtramos por misma serie y ordenamos ascendente por fecha
					const seriesPosts = allBlog
						.filter(p => p.data.series === isSeries && getLangFromSlug(p.slug) === lang)
						.sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf())

					const seriesHead = seriesPosts.length > 0 ? seriesPosts[0] : post
					acc.push(seriesHead)
				}
			} else {
				acc.push(post)
			}
			return acc
		},
		[] as typeof allBlog,
	)
---

<div
	class:list={[
		'unified-search-root relative flex flex-col overflow-hidden',
		mode === 'mobile' ? 'h-full' : 'h-auto max-h-[75vh]',
	]}
	data-input-id={inputId}
	data-container-id={resultsContainerId}
	data-mode={mode}>
	{/* Filtros Chips (SOLO MOBILE) */}
	{
		mode === 'mobile' && (
			<div
				class='scrollbar-hide flex shrink-0 gap-2 overflow-x-auto border-b border-zinc-100 px-4 py-3 dark:border-zinc-800'
				role='tablist'>
				<button
					class='filter-chip active text-xs shrink-0 rounded-full bg-[--tangerine] px-4 py-1.5 font-medium text-zinc-900 transition-colors'
					data-filter='all'>
					{lang === 'es' ? 'Todos' : lang === 'ca' ? 'Tots' : 'All'}
				</button>
				<button
					class='filter-chip text-xs shrink-0 rounded-full bg-zinc-100 px-4 py-1.5 font-medium text-zinc-600 transition-colors hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700'
					data-filter='blog'>
					DEV
				</button>
				<button
					class='filter-chip text-xs shrink-0 rounded-full bg-zinc-100 px-4 py-1.5 font-medium text-zinc-600 transition-colors hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700'
					data-filter='til'>
					TIL
				</button>
				<button
					class='filter-chip text-xs shrink-0 rounded-full bg-zinc-100 px-4 py-1.5 font-medium text-zinc-600 transition-colors hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700'
					data-filter='project'>
					PRO
				</button>
			</div>
		)
	}

	{/* Contenedor de Scroll de Resultados */}
	<div
		id={resultsContainerId}
		class='relative min-h-0 flex-1 scroll-py-3 overflow-y-auto px-6 py-6'>
		{/* Contenido Inicial (Server Rendered) */}
		<div id={`${resultsContainerId}-content`}>
			{/* Desktop: Usar Grid y Estilo de Tarjetas "Fancy" (Nav.astro original) */}
			{
				mode === 'desktop' ? (
					<>
						{recentProjects.length > 0 && (
							<div class='mb-6' data-section='project'>
								<h3 class='text-xs mb-3 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-2 mr-2 h-4 w-4'>
										<Fragment set:html={RocketIcon} />
									</span>
									{
										// TODO: Add proper translation key if 'nav.projects' exists, else fallback
										t('nav.projects') || 'Projects'
									}
								</h3>
								<div class='grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3'>
									{recentProjects.map((project, index) => (
										<a
											href={
												lang === 'es'
													? `/projects/${project.slug.split('/')[0]}/`
													: `/${lang}/projects/${project.slug.split('/')[0]}/`
											}
											class={`group relative block h-full min-h-[140px] overflow-hidden rounded-xl bg-white/90 p-5 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine] ${index >= 3 ? 'extra-item hidden' : ''}`}>
											{/* Header: Date + Arrow */}
											<div class='mb-2 flex items-center justify-between'>
												<time
													datetime={project.data.pubDate?.toISOString()}
													class='text-[10px] font-medium uppercase tracking-wide text-zinc-400 dark:text-zinc-500'>
													{project.data.pubDate?.toLocaleDateString(lang, {
														day: 'numeric',
														month: 'short',
														year: 'numeric',
													})}
												</time>
												<span class='opacity-0 transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-[--tangerine] group-hover:opacity-100'>
													<Fragment set:html={ArrowUpRightIcon} />
												</span>
											</div>

											{/* Content */}
											<div class='text-base font-semibold leading-tight text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-100 dark:group-hover:text-[--tangerine]'>
												{project.data.title}
											</div>
											<div class='text-xs mt-2 line-clamp-3 leading-relaxed text-zinc-500 dark:text-zinc-400'>
												{project.data.description}
											</div>
										</a>
									))}
								</div>
							</div>
						)}
						{recentTils.length > 0 && (
							<div class='mb-6' data-section='til'>
								<h3 class='text-xs mb-3 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-2 mr-2 h-4 w-4'>
										<Fragment set:html={PinIcon} />
									</span>
									{t('blog.til')}
								</h3>
								<div class='grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3'>
									{recentTils.map((tilItem, index) => (
										<a
											href={
												lang === 'es'
													? `/til/${tilItem.slug.split('/')[0]}/`
													: `/${lang}/til/${tilItem.slug.split('/')[0]}/`
											}
											class={`group relative block h-full min-h-[140px] overflow-hidden rounded-xl bg-white/90 p-5 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine] ${index >= 6 ? 'extra-item hidden' : ''}`}>
											{/* Header: Date + Arrow */}
											<div class='mb-2 flex items-center justify-between'>
												<time
													datetime={tilItem.data.pubDate.toISOString()}
													class='text-[10px] font-medium uppercase tracking-wide text-zinc-400 dark:text-zinc-500'>
													{tilItem.data.pubDate.toLocaleDateString(lang, {
														day: 'numeric',
														month: 'short',
														year: 'numeric',
													})}
												</time>
												<span class='opacity-0 transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-[--tangerine] group-hover:opacity-100'>
													<Fragment set:html={ArrowUpRightIcon} />
												</span>
											</div>

											{/* Content */}
											<div class='text-base font-semibold leading-tight text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-100 dark:group-hover:text-[--tangerine]'>
												{tilItem.data.title}
											</div>
											<div class='text-xs mt-2 line-clamp-3 leading-relaxed text-zinc-500 dark:text-zinc-400'>
												{tilItem.data.description}
											</div>
										</a>
									))}
								</div>
							</div>
						)}
						{recentPosts.length > 0 && (
							<div class='mb-6' data-section='blog'>
								<h3 class='text-xs mb-3 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-2 mr-2 h-4 w-4'>
										<Fragment set:html={BookmarkIcon} />
									</span>
									{t('blog.series')}
								</h3>
								<div class='grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3'>
									{recentPosts.map((blogItem, index) => (
										<a
											href={
												lang === 'es'
													? `/blog/${getBaseSlug(blogItem.slug)}/`
													: `/${lang}/blog/${getBaseSlug(blogItem.slug)}/`
											}
											class={`group relative block h-full min-h-[140px] overflow-hidden rounded-xl bg-white/90 p-5 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine] ${index >= 3 ? 'extra-item hidden' : ''}`}>
											{/* Header: Date + Arrow */}
											<div class='mb-2 flex items-center justify-between'>
												<time
													datetime={blogItem.data.pubDate.toISOString()}
													class='text-[10px] font-medium uppercase tracking-wide text-zinc-400 dark:text-zinc-500'>
													{blogItem.data.pubDate.toLocaleDateString(lang, {
														day: 'numeric',
														month: 'short',
														year: 'numeric',
													})}
												</time>
												<span class='opacity-0 transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-[--tangerine] group-hover:opacity-100'>
													<Fragment set:html={ArrowUpRightIcon} />
												</span>
											</div>

											{/* Content */}
											<div class='text-base font-semibold leading-tight text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-100 dark:group-hover:text-[--tangerine]'>
												{blogItem.data.title}
											</div>
											<div class='text-xs mt-2 line-clamp-3 leading-relaxed text-zinc-500 dark:text-zinc-400'>
												{blogItem.data.description}
											</div>
										</a>
									))}
								</div>
							</div>
						)}
					</>
				) : (
					// Mobile: Usar Lista y Estilo Search.astro original
					<>
						{recentProjects.length > 0 && (
							<div class='px-2 py-2' data-section='project'>
								<h3 class='text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-3 mr-2 h-4 w-4'>
										<Fragment set:html={RocketIcon} />
									</span>
									{t('nav.projects') || 'Projects'}
								</h3>
								<div class='space-y-3'>
									{recentProjects.slice(0, 3).map(proj => (
										<a
											href={
												lang === 'es'
													? `/projects/${proj.slug.split('/')[0]}/`
													: `/${lang}/projects/${proj.slug.split('/')[0]}/`
											}
											class='group block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]'>
											<h4 class='text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]'>
												{proj.data.title}
											</h4>
											<div class='text-xs mt-1 flex items-center gap-2 text-zinc-500 dark:text-zinc-400'>
												<time datetime={proj.data.pubDate?.toISOString()}>
													{proj.data.pubDate?.toLocaleDateString(lang)}
												</time>
											</div>
										</a>
									))}
								</div>
							</div>
						)}
						{recentTils.length > 0 && (
							<div class='px-2 py-2' data-section='til'>
								<h3 class='text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-3 mr-2 h-4 w-4'>
										<Fragment set:html={PinIcon} />
									</span>
									{t('blog.til')}
								</h3>
								<div class='space-y-3'>
									{recentTils.slice(0, 6).map(tilItem => (
										<a
											href={
												lang === 'es'
													? `/til/${tilItem.slug.split('/')[0]}/`
													: `/${lang}/til/${tilItem.slug.split('/')[0]}/`
											}
											class='group block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]'>
											<h4 class='text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]'>
												{tilItem.data.title}
											</h4>
											<div class='text-xs mt-1 flex items-center gap-2 text-zinc-500 dark:text-zinc-400'>
												<time datetime={tilItem.data.pubDate.toISOString()}>
													{tilItem.data.pubDate.toLocaleDateString(lang)}
												</time>
											</div>
										</a>
									))}
								</div>
							</div>
						)}

						{recentPosts.length > 0 && (
							<div
								class={`px-2 py-2 ${recentTils.length > 0 ? 'mt-4 border-t border-zinc-100 pt-4 dark:border-zinc-800' : ''}`}
								data-section='blog'>
								<h3 class='text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mb-3 mr-2 h-4 w-4'>
										<Fragment set:html={BookmarkIcon} />
									</span>
									{t('blog.series')}
								</h3>
								<div class='space-y-3'>
									{recentPosts.slice(0, 3).map(blogItem => (
										<a
											href={
												lang === 'es'
													? `/blog/${getBaseSlug(blogItem.slug)}/`
													: `/${lang}/blog/${getBaseSlug(blogItem.slug)}/`
											}
											class='group block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]'>
											<h4 class='text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]'>
												{blogItem.data.title}
											</h4>
											<p class='text-xs mt-1 line-clamp-1 text-zinc-500 dark:text-zinc-400'>
												{blogItem.data.description}
											</p>
										</a>
									))}
								</div>
							</div>
						)}
					</>
				)
			}

			{/* Estado vacío si no hay TILs ni Posts recientes */}
			{
				recentTils.length === 0 && recentPosts.length === 0 && (
					<div class='py-10 text-center text-sm text-zinc-500 dark:text-zinc-400'>
						<p>Escribe para buscar artículos y proyectos...</p>
					</div>
				)
			}
		</div>
	</div>

	{/* Spacer (Solo Mobile) */}
	{
		mode === 'mobile' && (
			<div class='pointer-events-none absolute bottom-0 left-0 right-0 z-20 h-24 bg-gradient-to-t from-white to-transparent dark:from-zinc-900' />
		)
	}
</div>

<script>
	// Script tipo Módulo para tener acceso a imports
	import RocketIcon from '../icons/rocket.svg?raw'
	import PinIcon from '../icons/pin.svg?raw'
	import BookmarkIcon from '../icons/bookmark.svg?raw'
	import { ui, defaultLang } from '../i18n/ui'

	// Clase para manejar la lógica de búsqueda instanciable
	class SearchController {
		// Class fields to satisfy TypeScript
		root;
		inputId;
		containerId;
		mode;
		/** @type {HTMLInputElement | null} */
		input;
		/** @type {HTMLElement | null} */
		resultsContainer;
		/** @type {HTMLElement | null} */
		contentContainer;
		/** @type {NodeListOf<HTMLElement> | null} */
		filterChips;
		currentFilter = 'all';
		defaultContent = '';
		/** @type {any[]} */
		lastSearchResults = [];
		/** @type {any} */
		pagefind = null;
		/** @type {number | null} */
		debounceTimeout = null;

		/** @param {HTMLElement} rootElement */
		constructor(rootElement) {
			this.root = rootElement
			this.inputId = this.root.dataset.inputId || ''
			this.containerId = this.root.dataset.containerId || ''
			this.mode = this.root.dataset.mode || 'desktop'
			this.input = /** @type {HTMLInputElement} */ (document.getElementById(this.inputId))
			this.resultsContainer = document.getElementById(this.containerId)
			this.contentContainer = document.getElementById(this.containerId + '-content')

			this.filterChips = this.root.querySelectorAll('.filter-chip')
			this.defaultContent = this.contentContainer ? this.contentContainer.innerHTML : ''

			// Si el input no existe al momento de construir (race condition?), intentar defer
			if (!this.input) {
				console.warn('UnifiedSearch: input not found', this.inputId)
			}

			this.init()
		}

		async init() {
			if (!this.input || !this.resultsContainer) return

			// Listeners de Input
			this.input.addEventListener('input', e => this.handleInput(e))
			this.input.addEventListener('focus', () => this.loadPagefind()) // Preload on focus

			// Listeners de Chips (Mobile)
			// @ts-ignore
			this.filterChips?.forEach(chip => {
				/** @type {HTMLElement} */
				const c = chip;
				c.addEventListener('click', () => {
					// @ts-ignore
					const newFilter = c.dataset.filter || 'all'
					this.setFilter(newFilter)
				})
			})

			// Listeners de Badges (Desktop/External) - IMPORTANTE
			if (this.mode === 'desktop') {
				this.input.addEventListener('badgeCreated', /** @param {Event} e */ e => {
					const customEvent = /** @type {CustomEvent} */ (e)
					const { filterType } = customEvent.detail
					this.setFilter(filterType) // Se asegura de que actualice UI y resultados
				})

				this.input.addEventListener('badgeRemoved', () => {
					this.setFilter('all')
				})

				// Listener para el evento custom 'searchInput' emitido por SearchBadges
				this.input.addEventListener('searchInput', /** @param {Event} e */ e => {
					const customEvent = /** @type {CustomEvent} */ (e)
					const { value, activeFilter } = customEvent.detail
					// Actualizar el filtro si cambió
					if (activeFilter !== this.currentFilter) {
						this.currentFilter = activeFilter || 'all'
					}

					// Disparar búsqueda
					this.handleSearch(value)
				})
			}
		}

		/** @param {string} filter */
		setFilter(filter) {
			if (this.currentFilter === filter) return
			this.currentFilter = filter
			this.updateChipsUI()

			// Si hay búsqueda activa, re-renderizar resultados
			if (this.input && this.input.value.trim()) {
				this.renderResults(this.lastSearchResults)
			} else {
				// Si no, filtrar contenido inicial
				this.filterInitialContent()
			}
		}

		updateChipsUI() {
			// Solo aplica si existen chips (Mobile)
			// @ts-ignore
			this.filterChips?.forEach(chip => {
				// @ts-ignore
				const filter = chip.dataset.filter
				const isSelected = filter === this.currentFilter

				if (isSelected) {
					chip.classList.add('bg-[--tangerine]', 'text-zinc-900', 'active')
					chip.classList.remove(
						'bg-zinc-100',
						'text-zinc-600',
						'dark:bg-zinc-800',
						'dark:text-zinc-400',
						'hover:bg-zinc-200',
						'dark:hover:bg-zinc-700',
					)
				} else {
					chip.classList.remove('bg-[--tangerine]', 'text-zinc-900', 'active')
					chip.classList.add(
						'bg-zinc-100',
						'text-zinc-600',
						'dark:bg-zinc-800',
						'dark:text-zinc-400',
						'hover:bg-zinc-200',
						'dark:hover:bg-zinc-700',
					)
				}
			})
		}

		filterInitialContent() {
			if (!this.contentContainer) return

			// Restaurar si estaba sobreescrito (ej. mensaje "No resultados")
			if (!this.contentContainer.querySelector('[data-section]')) {
				this.contentContainer.innerHTML = this.defaultContent
			}

			// Ahora ocultar/mostrar secciones e items extra
			const tilSection = this.contentContainer.querySelector('[data-section="til"]')
			const blogSection = this.contentContainer.querySelector('[data-section="blog"]')
			const projectSection = this.contentContainer.querySelector('[data-section="project"]')

			if (projectSection) {
				const visible = this.currentFilter === 'all' || this.currentFilter === 'project'
				projectSection.classList.toggle('hidden', !visible)

				// Mostrar items extra si el filtro es específico
				const extraItems = projectSection.querySelectorAll('.extra-item')
				extraItems.forEach(item => {
					item.classList.toggle('hidden', this.currentFilter !== 'project')
				})
			}

			if (tilSection) {
				const visible = this.currentFilter === 'all' || this.currentFilter === 'til'
				tilSection.classList.toggle('hidden', !visible)

				// Mostrar items extra si el filtro es específico
				const extraItems = tilSection.querySelectorAll('.extra-item')
				extraItems.forEach(item => {
					item.classList.toggle('hidden', this.currentFilter !== 'til')
				})
			}
			if (blogSection) {
				const visible = this.currentFilter === 'all' || this.currentFilter === 'blog'
				blogSection.classList.toggle('hidden', !visible)

				// Mostrar items extra si el filtro es específico
				const extraItems = blogSection.querySelectorAll('.extra-item')
				extraItems.forEach(item => {
					item.classList.toggle('hidden', this.currentFilter !== 'blog')
				})
			}
		}

		async loadPagefind() {
			if (this.pagefind) return
			try {
				const url = '/pagefind/pagefind.js'
				this.pagefind = await import(/* @vite-ignore */ url)
			} catch (e) {
				console.warn('Pagefind not found.')
			}
		}

		/** @param {Event} e */
		handleInput(e) {
			const target = /** @type {HTMLInputElement} */ (e.target)
			const val = target.value
			this.handleSearch(val)
		}

		/** @param {string} val */
		handleSearch(val) {
			if (this.debounceTimeout) clearTimeout(this.debounceTimeout)

			// Si se vacía, restaurar inicial
			if (!val || !val.trim()) {
				this.contentContainer.innerHTML = this.defaultContent
				this.filterInitialContent()
				return
			}

			this.debounceTimeout = window.setTimeout(() => {
				this.performSearch(val)
			}, 300)
		}

		/** @param {string} query */
		async performSearch(query) {
			if (!this.pagefind) await this.loadPagefind()
			if (!this.pagefind || !query.trim()) return

			// @ts-ignore
			const search = await this.pagefind?.search(query)
			if (!search) return
			// @ts-ignore
			const allResults = await Promise.all(search.results.map(r => r.data()))
			const currentLang = document.documentElement.lang || 'es'

			// Filter by language
			// Filter by language
			// @ts-ignore
			const langFilteredResults = allResults.filter(r => {
				// Use pagefind metadata 'language' if available
				if (r.language) return r.language === currentLang

				// Fallback: URL pattern matching
				if (currentLang === 'es') {
					// Spanish is root (no /en/ or /ca/ prefix)
					return !r.url.startsWith('/en/') && !r.url.startsWith('/ca/')
				}
				// Others must start with /lang/
				return r.url.startsWith(`/${currentLang}/`)
			})

			// Deduplicar
			const seenUrls = new Set()
			const results = []
			for (const result of langFilteredResults) {
				if (!seenUrls.has(result.url)) {
					seenUrls.add(result.url)
					results.push(result)
				}
			}

			this.lastSearchResults = results
			this.renderResults(results)
		}

	
		/** @param {any[]} results */
		renderResults(results) {
			if (!this.contentContainer) return

			// Filtrar por chip/badge activo
			let filtered = results
			if (this.currentFilter !== 'all') {
				// @ts-ignore
				filtered = results.filter(r => {
					// @ts-ignore
					if (this.currentFilter === 'project') return r.filters?.type?.includes('project')
					// @ts-ignore
					if (this.currentFilter === 'til') return r.filters?.type?.includes('til')
					if (this.currentFilter === 'blog')
						// @ts-ignore
						return !r.filters?.type || r.filters.type.includes('blog')
					return true
				})
			}

			const currentLang = document.documentElement.lang || defaultLang
			const t = ui[currentLang] || ui[defaultLang]

			if (filtered.length === 0) {
				this.contentContainer.innerHTML = `
					<div class="text-center py-10 text-sm text-zinc-500 dark:text-zinc-400">
						<p>${t['nav.noResults']}</p>
					</div>
				`
				return
			}

			// Renderizar
			// @ts-ignore
			const projects = filtered.filter(r => r.filters?.type?.includes('project'))
			// @ts-ignore
			const tils = filtered.filter(r => r.filters?.type?.includes('til'))
			// @ts-ignore
			const articles = filtered.filter(r => !r.filters?.type || r.filters.type.includes('blog'))

			let html = ''

			// Helper Render Item Wrapper (Switch logic based on mode)
			const isDesktop = this.mode === 'desktop'
			const containerClass = isDesktop
				? 'grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-3'
				: 'space-y-1'

			/** @param {any} item */
			const renderItem = item => {
				// Desktop Card Style (Simple but needs to match grid)
				if (isDesktop) {
					return `
                    <a href="${item.url}" class="group block h-full min-h-[140px] overflow-hidden rounded-xl bg-white/90 p-4 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:ring-[--tangerine] hover:shadow-lg dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]">
                        <div class="text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]">
                            ${item.meta.title}
                        </div>
                        <div class="mt-2 text-xs text-zinc-500 line-clamp-5 dark:text-zinc-400">
                            ${item.excerpt || item.meta.description}
                        </div>
                    </a>`
				}
				// Mobile List Style
				return `
				<a href="${item.url}" class="block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:ring-1 hover:ring-[--tangerine] hover:shadow-lg dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine] group">
					<h4 class="text-sm font-medium text-zinc-800 dark:text-zinc-200 group-hover:text-[--tangerine] dark:group-hover:text-[--tangerine] transition-colors">
						${item.meta.title}
					</h4>
					<p class="text-xs text-zinc-500 dark:text-zinc-400 line-clamp-1 mt-1">${item.excerpt || item.meta.description}</p>
				</a>`
			}

			/** 
			 * @param {string} title 
			 * @param {string} icon 
			 * @param {any[]} items 
			 */
			const renderSection = (title, icon, items) => `
                <div class="${isDesktop ? '' : 'px-2 py-2'} ${html !== '' ? (isDesktop ? '' : 'mt-4 border-t border-zinc-100 dark:border-zinc-800 pt-4') : ''}">
                    <h3 class="text-xs mb-3 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400">
                        <span class="mr-2 h-4 w-4">${icon}</span>
                        ${title}
                    </h3>
                    <div class="${containerClass}">${items.map(renderItem).join('')}</div>
                </div>
            `

			if (projects.length > 0) {
				html += renderSection(t['nav.projects'], RocketIcon, projects)
			}
			if (tils.length > 0) {
				html += renderSection(t['blog.til'], PinIcon, tils)
			}
			if (articles.length > 0) {
				html += renderSection(t['blog.series'], BookmarkIcon, articles)
			}

			// Wrapper para grid si es desktop
			if (isDesktop) {
				html = `<div class="space-y-6">${html}</div>`
			}

			this.contentContainer.innerHTML = html
		}
	}

	// Inicializar controladores para cada instancia
	document.querySelectorAll('.unified-search-root').forEach(root => {
		new SearchController(root)
	})
</script>
