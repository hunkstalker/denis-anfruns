---
import Button from './Button.astro'
import SwitchBtnThemeMode from './SwitchBtnThemeMode.astro'
import LanguagePicker from './LanguagePicker.astro'
import SideMenu from './SideMenu.astro'
import Search from './Search.astro'
import { useTranslations } from '../i18n/utils'
import { navItems } from '../i18n/navigation'

import MenuIcon from '../icons/menu.svg'
import BookmarkIcon from '../icons/bookmark.svg?raw'
import PinIcon from '../icons/pin.svg?raw'
import SearchIcon from '../icons/search.svg'

interface Props {
	lang?: 'es' | 'en' | 'ca'
}

const { lang = 'es' } = Astro.props
const t = useTranslations(lang)

import { getCollection } from 'astro:content'
import { getLangFromSlug, getBaseSlug } from '../utils/blogi18n'
import { getBlogPosts } from '../utils/blog-content'

import { getTils } from '../utils/til-content'

// Fetch recent items for default view
const allTils = await getTils()
const allBlog = (await getBlogPosts())
	// Filter drafts in PROD if needed (getBlogPosts logic handles drafts? No, we filter manually akin to getCollection logic if possible, or just rely on new logic)
	// getBlogPosts returns ALL. We should filter drafts.
	.filter(p => import.meta.env.PROD ? p.data.draft !== true : true)

const recentTils = allTils
	.filter((p) => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3)

const recentPosts = allBlog
	.filter((p) => getLangFromSlug(p.slug) === lang && p.data.pubDate)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.reduce(
		(acc, post) => {
			if (acc.length >= 3) return acc
			const isSeries = post.data.series
			if (isSeries) {
				const seriesExists = acc.some((p) => p.data.series === isSeries)
				if (!seriesExists) acc.push(post)
			} else {
				acc.push(post)
			}
			return acc
		},
		[] as typeof allBlog,
	)

const currentPath = Astro.url.pathname
---

<nav
	class="fixed left-0 right-0 top-0 z-50 border-b border-zinc-200/50 bg-white/70 shadow-sm backdrop-blur-md dark:border-zinc-700/50 dark:bg-zinc-900/70"
>
	<div class="container">
		<div class="flex items-center justify-between py-4 md:py-6">
			<!-- Menú izquierdo Móvil -->
			<div class="sm:hidden">
				<button id="menu-toggle">
					<MenuIcon />
				</button>
			</div>

			<!-- Nav izquierdo Desktop -->
			<div class="hidden sm:inline-flex md:gap-1">
				<div class="text-center">
					{
						navItems.map((navItem) => {
							const finalPath =
								lang === 'es'
									? navItem.path
									: `/${lang}${navItem.path === '/' ? '' : navItem.path}`
							const isActive =
								currentPath === finalPath ||
								(finalPath !== '/' && currentPath.startsWith(finalPath))
							return (
								<Button
									text={t(navItem.key)}
									link={finalPath}
									enabled={navItem.enabled}
									active={navItem.enabled && isActive}
								/>
							)
						})
					}
				</div>
			</div>

			<!-- Lado derecho -->
			<div class="flex items-center gap-4 md:gap-6">
				<!-- Botón de búsqueda móvil -->
				<button
					id="search-mobile-btn"
					class="text-zinc-500 transition-colors hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 md:hidden"
					aria-label="Search"
				>
					<SearchIcon class="h-5 w-5" />
				</button>

				<!-- Barra de búsqueda desktop -->
				<div class="group relative hidden md:block">
					<div class="relative">
						<span
							class="absolute inset-y-0 left-0 flex items-center pl-3 text-zinc-500 dark:text-zinc-400"
						>
							<SearchIcon class="h-4 w-4" />
						</span>
						<input
							type="text"
							placeholder={t('nav.search') || 'Buscar...'}
							class="w-96 rounded-xl border border-zinc-200 bg-zinc-100 py-2 pl-10 pr-12 text-sm text-zinc-800 transition-all placeholder:text-zinc-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-[--tangerine] dark:border-zinc-700 dark:bg-zinc-800/50 dark:text-zinc-200 dark:placeholder:text-zinc-400"
						/>
						<div class="absolute right-2 top-2 flex items-center gap-1">
							<span
								id="shortcut-key"
								class="rounded-lg border border-zinc-200 bg-zinc-50 px-2 py-0.5 text-[10px] font-medium text-zinc-500 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400"
								>⌘K</span
							>
						</div>
					</div>

					<!-- Resultados de búsqueda de escritorio -->
					<div
						id="desktop-search-results"
						class="invisible absolute right-0 top-full z-50 mt-3 w-96 origin-top-right transform overflow-hidden rounded-xl bg-white opacity-0 shadow-xl ring-1 ring-black/5 transition-all duration-200 group-focus-within:visible group-focus-within:opacity-100 dark:bg-zinc-900 dark:ring-white/10"
					>
						<!-- Los resultados que se insertarán aquí. La estructura actual es para cuando no hay búsqueda -->
						<div id="desktop-initial-content">
							{
								recentTils.length > 0 && (
									<div class="p-3">
										<h3 class="text-xs mb-2 flex items-center gap-2 px-2 font-semibold uppercase tracking-wider text-zinc-400">
											<span class="mr-2 h-4 w-4 text-zinc-400">
												<Fragment set:html={PinIcon} />
											</span>
											{t('blog.til')}
										</h3>
										<div class="space-y-1">
											{recentTils.map((tilItem) => (
												<a
													href={`/${lang}/til/${tilItem.slug.split('/').pop()}/`}
													class="group block rounded-md px-2 py-2 hover:bg-zinc-50 dark:hover:bg-zinc-800/50"
												>
													<div class="text-sm font-medium text-zinc-700 dark:text-zinc-300">
														{tilItem.data.title}
													</div>
												</a>
											))}
										</div>
									</div>
								)
							}

							{
								recentPosts.length > 0 && (
									<div class="p-3">
										<h3 class="text-xs mb-2 flex items-center gap-2 px-2 font-semibold uppercase tracking-wider text-zinc-400">
											<span class="mr-2 h-4 w-4 text-zinc-400">
												<Fragment set:html={BookmarkIcon} />
											</span>
											{t('blog.series')}
										</h3>
										<div class="space-y-1">
											{recentPosts.map((blogItem) => (
												<a
													href={`/${lang}/blog/${getBaseSlug(blogItem.slug)}/`}
													class="group block rounded-md px-2 py-2 hover:bg-zinc-50 dark:hover:bg-zinc-800/50"
												>
													<div class="text-sm font-medium text-zinc-700 dark:text-zinc-300">
														{blogItem.data.title}
													</div>
													<div class="text-xs mt-0.5 line-clamp-1 text-zinc-400">
														{blogItem.data.description}
													</div>
												</a>
											))}
										</div>
									</div>
								)
							}

							{
								recentTils.length === 0 && recentPosts.length === 0 && (
									<div class="p-4 text-center text-sm text-zinc-500 dark:text-zinc-400">
										Empieza a escribir...
									</div>
								)
							}
						</div>
					</div>
				</div>

				<LanguagePicker />
				<SwitchBtnThemeMode />
			</div>
		</div>
	</div>
</nav>

<Search lang={lang} />
<SideMenu lang={lang} />

<script>
	import RocketIcon from '../icons/rocket.svg?raw'
	import PinIcon from '../icons/pin.svg?raw'
	import BookmarkIcon from '../icons/bookmark.svg?raw'
	import { ui, defaultLang } from '../i18n/ui'

	const searchMobileBtn = document.getElementById('search-mobile-btn')
	searchMobileBtn?.addEventListener('click', () => {
		document.dispatchEvent(new CustomEvent('open-search'))
	})

	const shortcutKey = document.getElementById('shortcut-key')
	if (shortcutKey) {
		// navigator.platform is deprecated, using userAgent fallback
		const isMac = navigator.userAgent.includes('Mac')
		if (!isMac) {
			shortcutKey.textContent = 'Ctrl K'
		}
	}

	// Desktop shortcut to focus input
	const desktopInput = document.querySelector('.group input') as HTMLInputElement
	const desktopResults = document.getElementById('desktop-search-results')

	// We need to capture the initial HTML of the results container to restore it.
	// Since this script runs on the client, we can grab it immediately.
	const defaultDesktopContent = desktopResults ? desktopResults.innerHTML : ''

	let navPagefind: any = null

	async function loadNavPagefind() {
		if (navPagefind) return
		try {
			// @ts-ignore
			// Using a variable to prevent Vite from analyzing the import (it fails in dev because the file doesn't exist yet)
			const pagefindUrl = '/pagefind/pagefind.js'
			navPagefind = await import(/* @vite-ignore */ pagefindUrl)
		} catch (e) {
			console.warn('Pagefind not found (Nav).')
		}
	}

	async function searchNav(query: string) {
		if (!navPagefind || !query.trim()) {
			if (desktopResults) desktopResults.innerHTML = defaultDesktopContent
			return
		}
		const search = await navPagefind.search(query)
		const results = await Promise.all(search.results.map((r: any) => r.data()))
		renderNavResults(results)
	}

	function renderNavResults(results: any[]) {
		if (!desktopResults) return

		const currentLang = (document.documentElement.lang as keyof typeof ui) || defaultLang
		const t = ui[currentLang]

		let html = `<div class="max-h-96 overflow-y-auto divide-y divide-zinc-100 dark:divide-zinc-800">`

		if (results.length === 0) {
			html += `
				<div class="p-4 text-center text-sm text-zinc-500 dark:text-zinc-400">
					${t['nav.noResults']}
				</div>
			`
		}

		const projects = results.filter((r) => r.filters.type?.includes('project'))
		const tils = results.filter((r) => r.filters.type?.includes('til'))
		const devlogs = results.filter((r) => !r.filters.type || r.filters.type.includes('blog'))

		if (projects.length > 0) {
			html += `
        <div class="p-3">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2 px-2 flex items-center gap-2">
             <span class="w-4 h-4 text-zinc-400">${RocketIcon}</span>
             ${t['nav.projects']}
           </h3>
           <div class="space-y-1">
             ${projects.map((r) => renderNavItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (tils.length > 0) {
			html += `
        <div class="p-3">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2 px-2 flex items-center gap-2">
             <span class="w-4 h-4 text-zinc-400">${PinIcon}</span>
             ${t['blog.til']}
           </h3>
           <div class="space-y-1">
             ${tils.map((r) => renderNavItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (devlogs.length > 0) {
			html += `
        <div class="p-3">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2 px-2 flex items-center gap-2">
             <span class="w-4 h-4 text-zinc-400">${BookmarkIcon}</span>
             ${t['blog.series']}
           </h3>
           <div class="space-y-1">
             ${devlogs.map((r) => renderNavItem(r)).join('')}
           </div>
        </div>
      `
		}

		html += '</div>'
		desktopResults.innerHTML = html
	}

	function renderNavItem(item: any) {
		return `
      <a href="${item.url}" class="block px-2 py-2 rounded-md hover:bg-zinc-50 dark:hover:bg-zinc-800/50 group">
        <div class="text-sm font-medium text-zinc-700 dark:text-zinc-300 group-hover:text-[--tangerine] dark:group-hover:text-[--tangerine] transition-colors">
          ${item.meta.title}
        </div>
        <div class="text-xs text-zinc-400 line-clamp-1 mt-0.5">${item.meta.description || item.excerpt}</div>
      </a>
    `
	}

	let navTimeout: any
	if (desktopInput) {
		desktopInput.addEventListener('focus', loadNavPagefind)
		desktopInput.addEventListener('input', (e) => {
			const val = (e.target as HTMLInputElement).value
			clearTimeout(navTimeout)
			navTimeout = setTimeout(() => {
				searchNav(val)
			}, 300)
		})
	}

	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			if (document.activeElement === desktopInput) {
				desktopInput.blur()
			}
		}
		if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
			e.preventDefault()
			// Using offsetParent to check visibility (it's null if hidden)
			if (desktopInput && desktopInput.offsetParent !== null) {
				desktopInput.focus()
			} else {
				document.dispatchEvent(new CustomEvent('open-search'))
			}
		}
	})
</script>

<script>
	const btn = document.getElementById('menu-toggle')
	const menu = document.getElementById('side-menu')
	const overlay = document.getElementById('menu-overlay')

	function toggleMenu() {
		if (!menu?.classList.contains('transition-transform')) {
			menu?.classList.add('transition-transform', 'duration-300', 'ease-in-out')
		}
		menu?.classList.toggle('-translate-x-full')
		overlay?.classList.toggle('hidden')
	}

	btn?.addEventListener('click', toggleMenu)
	overlay?.addEventListener('click', toggleMenu)
</script>

<style>
	/* Donde se incluya el nav se apliará el padding-top al body para dar espacio */
	:global(body) {
		padding-top: 4rem;
	}
</style>
