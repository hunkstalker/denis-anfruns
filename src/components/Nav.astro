---
import Button from './Button.astro'
import SwitchBtnThemeMode from './SwitchBtnThemeMode.astro'
import LanguagePicker from './LanguagePicker.astro'
import { useTranslations } from '../i18n/utils'
import { navItems } from '../i18n/navigation'

import MenuIcon from '../icons/menu.svg'
import SideMenu from './SideMenu.astro'
import Search from './Search.astro'

interface Props {
	lang?: 'es' | 'en' | 'ca'
}

const { lang = 'es' } = Astro.props
const t = useTranslations(lang)

const currentPath = Astro.url.pathname
---

<nav class='fixed top-0 left-0 right-0 z-50 bg-white/70 dark:bg-zinc-900/70 backdrop-blur-md border-b border-zinc-200/50 dark:border-zinc-700/50 shadow-sm'>
	<div class='container'>
		<div class='flex items-center justify-between py-4 md:py-6'>

			<!-- Menú izquierdo Móvil -->
			<div class='sm:hidden'>
				<button id='menu-toggle' >
					<MenuIcon />
				</button>
			</div>

			<!-- Nav izquierdo Desktop -->
			<div class='hidden sm:inline-flex md:gap-1'>
				<div class='text-center'>
					{navItems.map(item => {
            const finalPath = lang === 'es' ? item.path : `/${lang}${item.path === '/' ? '' : item.path}`
						const isActive = currentPath === finalPath || (finalPath !== '/' && currentPath.startsWith(finalPath))
						return (
							<Button text={t(item.key)} link={finalPath} enabled={item.enabled} active={item.enabled && isActive} />
						)
					})}
				</div>
			</div>

			<!-- Lado derecho -->
			<div class='flex gap-4 md:gap-6 items-center'>
        
        <!-- Mobile Search Button -->
        <button id="search-mobile-btn" class="md:hidden text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 transition-colors" aria-label="Search">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>

        <!-- Desktop Search Input -->
        <div class="hidden md:block relative group">
          <div class="relative">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-zinc-500 dark:text-zinc-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </span>
            <input 
              type="text" 
              placeholder={t('nav.search') || 'Buscar...'} 
              class="w-96 bg-zinc-100 dark:bg-zinc-800/50 border border-zinc-200 dark:border-zinc-700 rounded-xl py-2 pl-10 pr-12 text-sm text-zinc-800 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-[--tangerine] focus:border-transparent transition-all placeholder:text-zinc-500 dark:placeholder:text-zinc-400"
            />
            <div class="absolute right-2 top-2 flex items-center gap-1">
              <span id="shortcut-key" class="text-[10px] font-medium text-zinc-500 dark:text-zinc-400 border border-zinc-200 dark:border-zinc-700 rounded-lg px-2 py-0.5 bg-zinc-50 dark:bg-zinc-800">⌘K</span>
            </div>
          </div>

          <!-- Desktop Results Dropdown (Placeholder) -->
          <div class="absolute top-full right-0 mt-3 w-96 bg-white dark:bg-zinc-900 rounded-xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 opacity-0 invisible group-focus-within:opacity-100 group-focus-within:visible transition-all duration-200 transform origin-top-right overflow-hidden z-50">
             <!-- Categorized Results Demo -->
             <div class="divide-y divide-zinc-100 dark:divide-zinc-800">
                <div class="p-3">
                  <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2 px-2">Artículos recientes</h3>
                  <div class="space-y-1">
                    <a href="#" class="block px-2 py-2 rounded-md hover:bg-zinc-50 dark:hover:bg-zinc-800/50 text-sm text-zinc-700 dark:text-zinc-300">
                      StarDraw: Implementando el Canvas
                    </a>
                  </div>
                </div>
             </div>
          </div>
        </div>

				<LanguagePicker />
				<SwitchBtnThemeMode />
			</div>
		</div>
	</div>
</nav>

<Search lang={lang} />
<SideMenu lang={lang} />

<script>
  // ... existing menu script ...
  const searchMobileBtn = document.getElementById('search-mobile-btn');
  searchMobileBtn?.addEventListener('click', () => {
    document.dispatchEvent(new CustomEvent('open-search'));
  });

  const shortcutKey = document.getElementById('shortcut-key');
  if (shortcutKey) {
    // navigator.platform is deprecated, using userAgent fallback
    const isMac = navigator.userAgent.includes('Mac');
    if (!isMac) {
      shortcutKey.textContent = 'Ctrl K';
    }
  }

  // Desktop shortcut to focus input
  const desktopInput = document.querySelector('.group input') as HTMLInputElement;
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.activeElement === desktopInput) {
        desktopInput.blur();
      }
    }
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      // Using offsetParent to check visibility (it's null if hidden)
      if (desktopInput && desktopInput.offsetParent !== null) {
         desktopInput.focus();
      } else {
         document.dispatchEvent(new CustomEvent('open-search'));
      }
    }
  });
</script>

<script>
  const btn = document.getElementById('menu-toggle');
  const menu = document.getElementById('side-menu');
  const overlay = document.getElementById('menu-overlay');

  function toggleMenu() {
    if (!menu?.classList.contains('transition-transform')) {
      menu?.classList.add('transition-transform', 'duration-300', 'ease-in-out');
    }
    menu?.classList.toggle('-translate-x-full');
    overlay?.classList.toggle('hidden');
  }

  btn?.addEventListener('click', toggleMenu);
  overlay?.addEventListener('click', toggleMenu);
</script>

<style>
	/* Donde se incluya el nav se apliará el padding-top al body para dar espacio */
	:global(body) {
		padding-top: 4rem;
	}
</style>
