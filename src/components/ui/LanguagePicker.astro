---
import { languages } from '../../i18n/ui'
import { getLangFromUrl, useTranslations } from '../../i18n/utils'

const currentLang = getLangFromUrl(Astro.url)
const t = useTranslations(currentLang as any)
const currentPath = Astro.url.pathname

function getPathForLang(lang: string) {
	// Eliminar barra inicial y dividir
	const segments = currentPath.replace(/^\//, '').split('/').filter(Boolean)
	const firstSegment = segments[0]

	// Comprobar si el primer segmento es un código de idioma conocido (excepto 'es' que es el default)
	// Nota: 'es' no debería aparecer en la URL según tu configuración actual, pero lo comprobamos por seguridad
	const isLangSegment = firstSegment && firstSegment in languages && firstSegment !== 'es'

	let newSegments = [...segments]

	if (isLangSegment) {
		if (lang === 'es') {
			// Si cambiamos a español (default), quitamos el segmento de idioma
			newSegments.shift()
		} else {
			// Si cambiamos a otro idioma, reemplazamos el segmento
			newSegments[0] = lang
		}
	} else {
		if (lang !== 'es') {
			// Si no estamos en un segmento de idioma y vamos a uno no-default, lo añadimos al principio
			newSegments.unshift(lang)
		}
		// Si vamos a 'es' y no hay segmento, no hacemos nada (ya estamos en la raíz relativa)
	}

	let path = '/' + newSegments.join('/')
	
	// Ensure trailing slash for non-root paths to avoid 308 redirects
	if (path !== '/' && !path.endsWith('/')) {
		path += '/'
	}

	return path
}
---

<div class="flex items-center gap-3 rounded-lg bg-zinc-200 px-3 py-1.5 dark:bg-zinc-800">
	{
		Object.keys(languages).map((lang) => (
			<a
				href={getPathForLang(lang)}
				data-lang={lang}
				data-astro-prefetch="hover"
				class:list={[
					'text-xs language-link font-bold transition-all duration-200 sm:text-sm',
					{
						'pointer-events-none scale-110 cursor-default text-[var(--tangerine-hover)] dark:text-[var(--tangerine)]':
							lang === currentLang,
						'text-zinc-500 hover:text-zinc-800 dark:text-zinc-400 dark:hover:text-zinc-200':
							lang !== currentLang,
					},
				]}
				aria-label={`${t('language.changeTo')} ${languages[lang as keyof typeof languages]}`}
			>
				{lang.toUpperCase()}
			</a>
		))
	}
</div>

<script>
	const links = document.querySelectorAll('.language-link')
	
	// Sync visual state with localStorage on 404 page (URL doesn't contain lang)
	const is404Page = document.getElementById('error-title') !== null
	if (is404Page) {
		const savedLang = localStorage.getItem('selectedLang') || 'es'
		links.forEach((link) => {
			const linkEl = link as HTMLAnchorElement
			const lang = linkEl.dataset.lang
			if (lang === savedLang) {
				linkEl.classList.remove('text-zinc-500', 'hover:text-zinc-800', 'dark:text-zinc-400', 'dark:hover:text-zinc-200')
				linkEl.classList.add('pointer-events-none', 'scale-110', 'cursor-default', 'text-[var(--tangerine-hover)]', 'dark:text-[var(--tangerine)]')
			} else {
				linkEl.classList.remove('pointer-events-none', 'scale-110', 'cursor-default', 'text-[var(--tangerine-hover)]', 'dark:text-[var(--tangerine)]')
				linkEl.classList.add('text-zinc-500', 'hover:text-zinc-800', 'dark:text-zinc-400', 'dark:hover:text-zinc-200')
			}
		})
	}

	links.forEach((link) => {
		link.addEventListener('click', (e) => {
			const target = e.currentTarget as HTMLAnchorElement
			const lang = target.dataset.lang
			if (lang) {
				localStorage.setItem('selectedLang', lang)
			}

			// On 404 page, just reload to apply new language
			if (is404Page) {
				e.preventDefault()
				window.location.reload()
				return
			}

			// Persist query params (e.g. ?tag=react)
			if (window.location.search) {
				e.preventDefault()
				const url = new URL(target.href)
				// Merge current search params with target params (if any)
				const currentParams = new URL(window.location.href).searchParams
				currentParams.forEach((value, key) => {
					url.searchParams.set(key, value)
				})
				window.location.href = url.toString()
			}
		})
	})
</script>
