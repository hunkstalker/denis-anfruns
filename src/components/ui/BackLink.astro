---
import ChevronLeft from '@icons/chevron-left.svg'
import { useTranslations } from '@i18n/utils'
import type { SupportedLang } from '@utils/blogi18n'

interface Props {
	href: string
	label: string
	class?: string
	hideIcon?: boolean
	id?: string
}

const { href, label, class: className, hideIcon = false, id } = Astro.props
const lang = (Astro.currentLocale || 'es') as SupportedLang
const t = useTranslations(lang)
const backLabel = t('blog.back')
---

<a
	href={href}
	id={id || (className?.includes('go-back') ? 'go-back-link' : undefined)}
	data-astro-prefetch
	data-back-label={backLabel}
	class:list={[
		'animate-fade-in-up mb-6 mt-2.5 flex w-fit items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-[--tangerine-hover] dark:hover:text-[--tangerine]',
		className,
	]}
>
	{!hideIcon && <ChevronLeft />}
	<span class="link-text">{label}</span>
</a>

<script>
	document.addEventListener('astro:page-load', () => {
		const goBackLink = document.getElementById('go-back-link') as HTMLAnchorElement

		if (goBackLink) {
			const savedOrigin = sessionStorage.getItem('backlink-origin')
			const isInternalReferrer =
				document.referrer && document.referrer.startsWith(window.location.origin)

			// 1. Check if we have a saved origin (e.g. from Privacy Policy)
			if (savedOrigin && savedOrigin.startsWith(window.location.origin)) {
				goBackLink.addEventListener('click', (e) => {
					e.preventDefault()
					sessionStorage.removeItem('backlink-origin')
					window.location.href = savedOrigin
				})
			}
			// 2. Smart Logic: Check if we came from /blog/ or /til/
			else if (isInternalReferrer) {
				const referrerPath = new URL(document.referrer).pathname
				const cameFromBlog = referrerPath.includes('/blog')
				const cameFromTil = referrerPath.includes('/til')

				const currentPath = window.location.pathname
				const isOnTil = currentPath.includes('/til/')
				const isSamePage = referrerPath === currentPath

				if (!isSamePage) {
					if ((isOnTil && cameFromTil) || (isOnTil && cameFromBlog)) {
						// Update text to generic "Go back"
						const textSpan = goBackLink.querySelector('.link-text')
						if (textSpan && goBackLink.dataset.backLabel) {
							textSpan.textContent = goBackLink.dataset.backLabel
						}

						// Use history.back() to preserve scroll position
						goBackLink.addEventListener('click', (e) => {
							e.preventDefault()
							history.back()
						})
					}
				}
			}
		}
	})
</script>
