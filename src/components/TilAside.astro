---
import { getCollection } from 'astro:content'
import { useTranslations } from '../i18n/utils'
import { getTils } from '../utils/til-content'
import ArrowLink from '../icons/arrow-link.svg'

interface Props {
	lang: 'es' | 'en' | 'ca'
}

const { lang } = Astro.props
const t = useTranslations(lang)

const tilCollection = await getTils()
const tils = tilCollection
	.filter((p) => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
---

<aside class="space-y-6 sm:space-y-8 lg:col-span-4">
	<div
		class="rounded-xl border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-800 dark:bg-zinc-900/50 sm:p-6 lg:sticky lg:top-24"
	>
		<h2
			class="mb-6 flex items-center gap-2 border-b border-zinc-200 pb-2 text-xl font-bold dark:border-zinc-700 dark:text-zinc-200"
		>
			{t('blog.til')}
		</h2>

		<div class="space-y-4">
			{tils.length === 0 && <p class="text-sm italic text-zinc-500">{t('blog.withoutTILs')}</p>}

			{
				tils.map((post) => (
					<article class="til-card group relative flex translate-y-8 flex-col gap-2 rounded-xl border border-zinc-200 bg-white p-4 opacity-0 shadow-sm transition-all duration-700 ease-out hover:border-black/15 hover:shadow-md dark:border-zinc-700/50 dark:bg-zinc-800 dark:hover:border-white/15">
						<div class="mb-1 flex items-center justify-between gap-2">
							<time
								class="text-xs flex items-center gap-3 text-zinc-500"
								datetime={post.data.pubDate.toISOString()}
							>
								{post.data.pubDate.toLocaleDateString(undefined, {
									month: 'short',
									day: 'numeric',
									year: 'numeric',
								})}
							</time>
						</div>

						<p class="mb-4 line-clamp-2 dark:text-white">
							<a
								href={
									lang === 'es'
										? `/til/${post.slug.split('/')[0]}/`
										: `/${lang}/til/${post.slug.split('/')[0]}/`
								}
							>
								<span class="absolute inset-0" />
								{post.data.title}
							</a>
						</p>
						<div class="flex items-center gap-2 text-sm font-medium text-[--tangerine-hover] dark:text-[--tangerine]">
							Leer nota
							<ArrowLink />
						</div>
					</article>
				))
			}
		</div>

		<div class="mt-6 border-t border-zinc-200 pt-6 text-center dark:border-zinc-700">
			<p class="text-sm text-zinc-500">{t('blog.tilDescription')}</p>
		</div>
	</div>
</aside>

<script>
	const observerOptions = {
		root: null,
		rootMargin: '0px',
		threshold: 0.1,
	}

	const observer = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			if (entry.isIntersecting) {
				entry.target.classList.remove('opacity-0', 'translate-y-8')
				observer.unobserve(entry.target)
			}
		})
	}, observerOptions)

	document.querySelectorAll('.til-card').forEach((el) => {
		observer.observe(el)
	})
</script>
