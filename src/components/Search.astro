---
// Importación de utilidades de internalización (i18n)
import { useTranslations } from '../i18n/utils'

// Importación de funciones para obtener contenido (TILs y Posts)
import { getTils } from '../utils/til-content'
import { getBlogPosts } from '../utils/blog-content'
import { getLangFromSlug, getBaseSlug } from '../utils/blogi18n'

// Importación de Iconos SVG
import SearchIcon from '../icons/search.svg'
import CloseIcon from '../icons/close.svg'
import PinIcon from '../icons/pin.svg?raw' // Importación "raw" para inyectar SVG directamente
import BookmarkIcon from '../icons/bookmark.svg?raw'

// Definición de las Props del componente
interface Props {
	lang: 'es' | 'en' | 'ca'
}

// Extracción de props y configuración de traducciones
const { lang = 'es' } = Astro.props
const t = useTranslations(lang)

// --- LÓGICA DEL SERVIDOR (Build Time) ---

// 1. Obtener todos los elementos recientes de TIL y Blog para la vista por defecto
const allTils = await getTils()
const allBlog = await getBlogPosts()

// 2. Filtrar TILs por idioma actual, ordenar por fecha descendente y tomar los 3 más recientes
const recentTils = allTils
	.filter(p => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3)

// 3. Filtrar Posts por idioma actual, ordenar y tomar los 3 más recientes
const recentPosts = allBlog
	.filter(post => getLangFromSlug(post.slug) === lang && post.data.pubDate)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3)
---

<!-- Modal de búsqueda para dispositivos móviles (y desktop overlay) -->
<div id='search-modal' class='fixed inset-0 z-50 hidden' role='dialog' aria-modal='true'>
	<!-- Fondo Oscuro / Backdrop con efecto blur -->
	<div
		class='fixed inset-0 bg-zinc-900/30 opacity-0 backdrop-blur-sm transition-opacity duration-300'
		id='search-backdrop'>
	</div>

	<!-- Panel del Modal:
         Mobile: Top-anchored, 90vh height (h-[90vh]), padding bottom implied by height not being 100%.
         Desktop (sm+): Centered/Top padding standard behavior.
    -->
	<div
		class='pointer-events-none fixed inset-0 z-10 flex flex-col items-center justify-start p-0 sm:p-6 md:p-20'>
		<div
			id='search-panel'
			class='pointer-events-auto flex h-[70vh] w-full -translate-y-4 transform flex-col overflow-hidden rounded-b-2xl bg-white opacity-0 shadow-2xl ring-1 ring-black/5 transition-all duration-300 ease-out dark:bg-zinc-900 sm:mx-auto sm:h-auto sm:max-h-[80vh] sm:max-w-5xl sm:rounded-xl'>
			<!-- Campo de Búsqueda (Input) + Botón Cerrar -->
			<div
				class='relative flex shrink-0 items-center border-b border-zinc-100 dark:border-zinc-800'>
				<SearchIcon class='pointer-events-none absolute left-4 h-5 w-5 text-zinc-400' />
				<input
					type='text'
					class='h-14 w-full border-0 bg-transparent pl-11 pr-12 text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-0 dark:text-white sm:h-12 sm:text-sm'
					placeholder='Buscar...'
					role='combobox'
					aria-expanded='false'
					aria-controls='options'
				/>
				<!-- Botón Cerrar (Mobile visible, could be visible on desktop too but typically click-outside is enough there) -->
				<button
					id='close-search-btn'
					class='absolute right-4 p-1 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200'>
					<CloseIcon class='h-5 w-5' />
				</button>
			</div>

			<!-- Lista de Resultados (Contenedor con scroll) -->
			<div
				id='search-results-container'
				class='min-h-0 flex-1 scroll-py-3 overflow-y-auto px-3 pb-10 pt-3'>
				<!-- Contenido Inicial: Se muestra antes de buscar nada (Renderizado en Servidor) -->
				<div id='initial-results-content'>
					{/* Sección de TILs recientes */}
					{
						recentTils.length > 0 && (
							<div class='px-2 py-2'>
								<h3 class='text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mr-2 h-4 w-4 mb-3'>
										<Fragment set:html={PinIcon} />
									</span>
									{t('blog.til')}
								</h3>
								<div class='space-y-3'>
									{recentTils.map(tilItem => (
										<a
											href={
												lang === 'es'
													? `/til/${tilItem.slug.split('/')[0]}/`
													: `/${lang}/til/${tilItem.slug.split('/')[0]}/`
											}
											class='group block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]'>
											<h4 class='text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]'>
												{tilItem.data.title}
											</h4>
											<div class='text-xs mt-1 flex items-center gap-2 text-zinc-500 dark:text-zinc-400'>
												<time datetime={tilItem.data.pubDate.toISOString()}>
													{tilItem.data.pubDate.toLocaleDateString(lang)}
												</time>
											</div>
										</a>
									))}
								</div>
							</div>
						)
					}

					{/* Sección de Posts recientes */}
					{
						recentPosts.length > 0 && (
							<div
								class={`px-2 py-2 ${recentTils.length > 0 ? 'mt-4 border-t border-zinc-100 pt-4 dark:border-zinc-800' : ''}`}>
								<h3 class='text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-800 dark:text-zinc-400'>
									<span class='mr-2 h-4 w-4 mb-3'>
										<Fragment set:html={BookmarkIcon} />
									</span>
									{t('blog.series')}
								</h3>
								<div class='space-y-3'>
									{recentPosts.map(blogItem => (
										<a
											href={
												lang === 'es'
													? `/blog/${getBaseSlug(blogItem.slug)}/`
													: `/${lang}/blog/${getBaseSlug(blogItem.slug)}/`
											}
											class='group block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:shadow-lg hover:ring-1 hover:ring-[--tangerine] dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine]'>
											<h4 class='text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]'>
												{blogItem.data.title}
											</h4>
											<p class='text-xs mt-1 line-clamp-1 text-zinc-500 dark:text-zinc-400'>
												{blogItem.data.description}
											</p>
										</a>
									))}
								</div>
							</div>
						)
					}

					{/* Estado vacío si no hay TILs ni Posts recientes */}
					{
						recentTils.length === 0 && recentPosts.length === 0 && (
							<div class='py-10 text-center text-sm text-zinc-500 dark:text-zinc-400'>
								<p>Escribe para buscar artículos y proyectos...</p>
							</div>
						)
					}
				</div>
			</div>

			<!-- Spacer sólido inferior para tapar el corte del scroll -->
			<div
				class='pointer-events-none absolute bottom-0 left-0 right-0 z-20 h-6 bg-white dark:bg-zinc-900'>
			</div>
		</div>
	</div>
</div>

<script>
	// --- LÓGICA DEL CLIENTE (Browser) ---

	import RocketIcon from '../icons/rocket.svg?raw'
	import PinIcon from '../icons/pin.svg?raw'
	import BookmarkIcon from '../icons/bookmark.svg?raw'
	import { ui, defaultLang } from '../i18n/ui'

	// Referencias a elementos del DOM
	const modal = document.getElementById('search-modal')
	const backdrop = document.getElementById('search-backdrop')
	const panel = document.getElementById('search-panel')
	const input = modal?.querySelector('input')
	const resultsContainer = modal?.querySelector('#search-results-container')
	const closeBtn = document.getElementById('close-search-btn')
	// Almacenar el contenido HTML inicial (renderizado por el servidor) para restaurarlo cuando no hay búsqueda
	const defaultContent = resultsContainer?.innerHTML || ''

	let pagefind: any = null

	// Carga perezosa (Lazy Load) de Pagefind
	async function loadPagefind() {
		if (pagefind) return
		try {
			// @ts-ignore
			const url = '/pagefind/pagefind.js'
			pagefind = await import(/* @vite-ignore */ url)
		} catch (e) {
			console.warn('Pagefind not found. Search will only work in production build.')
		}
	}

	// Función para ABRIR el buscador
	function openSearch() {
		modal?.classList.remove('hidden')
		document.body.classList.add('overflow-hidden') // Bloquear scroll

		// Animación de entrada
		// Usamos requestAnimationFrame para asegurar que la clase 'hidden' se ha quitado y el navegador ha renderizado
		requestAnimationFrame(() => {
			backdrop?.classList.remove('opacity-0')
			panel?.classList.remove('opacity-0', '-translate-y-4')
		})

		input?.focus()
		loadPagefind()

		// Restaurar contenido por defecto
		if (input && !input.value.trim() && resultsContainer) {
			resultsContainer.innerHTML = defaultContent
		}
	}

	// Función para CERRAR el buscador
	function closeSearch() {
		// Animación de salida
		backdrop?.classList.add('opacity-0')
		panel?.classList.add('opacity-0', '-translate-y-4')

		document.body.classList.remove('overflow-hidden') // Desbloquear scroll

		// Esperar a que termine la transición (300ms) antes de ocultar
		setTimeout(() => {
			modal?.classList.add('hidden')
		}, 300)
	}

	// Listener del botón cerrar
	closeBtn?.addEventListener('click', closeSearch)

	// Función para EJECUTAR la búsqueda
	async function performSearch(query: string) {
		if (!pagefind || !query.trim()) {
			// Si no hay librería o query vacía, restaurar contenido inicial "Recientes"
			if (resultsContainer) resultsContainer.innerHTML = defaultContent
			return
		}

		// Ejecutar búsqueda en Pagefind
		const search = await pagefind.search(query)
		// Cargar datos completos de los resultados
		const allResults = await Promise.all(search.results.map((r: any) => r.data()))

		// Filtrar duplicados: Pagefind puede devolver múltiples resultados para la misma URL.
		// Nos quedamos con el primero (más relevante).
		const seenUrls = new Set()
		const results = []
		for (const result of allResults) {
			if (!seenUrls.has(result.url)) {
				seenUrls.add(result.url)
				results.push(result)
			}
		}

		renderResults(results)
	}

	// Función para RENDERIZAR los resultados en el DOM
	function renderResults(results: any[]) {
		if (!resultsContainer) return

		// Obtener idioma actual para traducciones dinámicas en cliente
		const currentLang = (document.documentElement.lang as keyof typeof ui) || defaultLang
		const t = ui[currentLang]

		if (results.length === 0) {
			resultsContainer.innerHTML = `
        <div class="text-center py-10 text-sm text-zinc-500 dark:text-zinc-400">
           ${input?.value ? `<p>${t['nav.noResults']}</p>` : '<p>Escribe para buscar artículos y proyectos...</p>'}
        </div>
      `
			return
		}

		// Clasificar resultados por tipo (basado en filtros de Pagefind)
		const projects = results.filter(r => r.filters.type?.includes('project'))
		const tils = results.filter(r => r.filters.type?.includes('til'))
		const articles = results.filter(r => !r.filters.type || r.filters.type.includes('blog'))

		let html = ''

		if (projects.length > 0) {
			html += `
        <div class="px-2 py-2">
           <h3 class="text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-400">
             <span class="mr-2 h-4 w-4 text-zinc-400">${RocketIcon}</span>
             ${t['nav.projects']}
           </h3>
           <div class="space-y-1">
             ${projects.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (tils.length > 0) {
			html += `
        <div class="px-2 py-2 ${projects.length > 0 ? 'mt-4 border-t border-zinc-100 dark:border-zinc-800 pt-4' : ''}">
           <h3 class="text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-400">
             <span class="mr-2 h-4 w-4 text-zinc-400">${PinIcon}</span>
             ${t['blog.til']}
           </h3>
           <div class="space-y-1">
             ${tils.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (articles.length > 0) {
			html += `
        <div class="px-2 py-2 ${projects.length > 0 || tils.length > 0 ? 'mt-4 border-t border-zinc-100 dark:border-zinc-800 pt-4' : ''}">
           <h3 class="text-xs mb-2 flex items-center gap-2 font-semibold uppercase tracking-wider text-zinc-400">
             <span class="mr-2 h-4 w-4 text-zinc-400">${BookmarkIcon}</span>
             ${t['blog.series']}
           </h3>
           <div class="space-y-1">
             ${articles.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		resultsContainer.innerHTML = html
	}

	// Helper para renderizar un item individual
	function renderItem(item: any) {
		return `
      <a href="${item.url}" class="block rounded-xl bg-white/90 p-3 ring-1 ring-zinc-200/50 transition-all duration-200 ease-out hover:bg-white hover:ring-1 hover:ring-[--tangerine] hover:shadow-lg dark:bg-zinc-900/90 dark:ring-zinc-700/50 dark:hover:bg-zinc-800 dark:hover:ring-[--tangerine] group">
        <h4 class="text-sm font-medium text-zinc-800 dark:text-zinc-200 group-hover:text-[--tangerine] dark:group-hover:text-[--tangerine] transition-colors">
          ${item.meta.title}
        </h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400 line-clamp-1 mt-1">${item.excerpt || item.meta.description}</p>
      </a>
    `
	}

	// Debounce: Esperar 300ms a que el usuario deje de escribir para buscar
	let timeout: any
	input?.addEventListener('input', e => {
		const val = (e.target as HTMLInputElement).value
		clearTimeout(timeout)
		timeout = setTimeout(() => {
			performSearch(val)
		}, 300)
	})

	// Event Listeners Globales: Cerrar con ESC
	window.addEventListener('keydown', e => {
		if (e.key === 'Escape') {
			closeSearch()
		}
	})

	// Cerrar al hacer clic en el backdrop
	backdrop?.addEventListener('click', closeSearch)

	// Cerrar al hacer clic fuera del contenido del modal
	const wrapper = modal?.querySelector('.fixed.z-10')
	wrapper?.addEventListener('click', e => {
		if (e.target === wrapper) {
			closeSearch()
		}
	})

	// Evento Personalizado: Permite abrir el buscador desde otros componentes (ej: Navbar)
	document.addEventListener('open-search', openSearch)
</script>
