---
import { getCollection } from 'astro:content'
import { useTranslations } from '../i18n/utils'
import { getTils } from '../utils/til-content'
import { getBlogPosts } from '../utils/blog-content'
import { getLangFromSlug, getBaseSlug } from '../utils/blogi18n'
import SearchIcon from '../icons/search.svg'

interface Props {
	lang: 'es' | 'en' | 'ca'
}

const { lang = 'es' } = Astro.props
const t = useTranslations(lang)

// Fetch recent items for default view
const allTils = await getTils()
const allBlog = await getBlogPosts()

// Filter by lang and sort
const recentTils = allTils
	.filter((p) => p.data.lang === lang)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3) // Top 3 TILs

const recentPosts = allBlog
	.filter((post) => getLangFromSlug(post.slug) === lang && post.data.pubDate)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3) // Top 3 Posts
---

<div id="search-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
	<!-- Backdrop -->
	<div
		class="fixed inset-0 bg-zinc-900/50 backdrop-blur-sm transition-opacity"
		id="search-backdrop"
	>
	</div>

	<!-- Modal Panel -->
	<div class="fixed inset-0 z-10 overflow-y-auto p-4 sm:p-6 md:p-20">
		<div
			class="mx-auto max-w-2xl transform divide-y divide-zinc-100 overflow-hidden rounded-xl bg-white shadow-2xl ring-1 ring-black/5 transition-all dark:divide-zinc-800 dark:bg-zinc-900"
		>
			<!-- Input Search -->
			<div class="relative">
				<SearchIcon class="pointer-events-none absolute left-4 top-3.5 h-5 w-5 text-zinc-400" />
				<input
					type="text"
					class="h-12 w-full border-0 bg-transparent pl-11 pr-4 text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-0 dark:text-white sm:text-sm"
					placeholder="Buscar..."
					role="combobox"
					aria-expanded="false"
					aria-controls="options"
					auto-focus
				/>
			</div>

			<!-- Results List -->
			<div id="search-results-container" class="max-h-96 scroll-py-3 overflow-y-auto p-3">
				<!-- Default Content (Recent Items) -->
				<div id="initial-results-content">
					{
						recentTils.length > 0 && (
							<div class="px-2 py-2">
								<h3 class="text-xs mb-2 font-semibold uppercase tracking-wider text-zinc-400">
									ğŸ’¡ Recientes: TIL
								</h3>
								<div class="space-y-1">
									{recentTils.map((tilItem) => (
										<a
											href={`/${lang}/til/${tilItem.slug.split('/').pop()}/`}
											class="group block rounded-lg px-3 py-2 transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-800"
										>
											<h4 class="text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]">
												{tilItem.data.title}
											</h4>
											<div class="text-xs mt-0.5 flex items-center gap-2 text-zinc-500 dark:text-zinc-400">
												<time datetime={tilItem.data.pubDate.toISOString()}>
													{tilItem.data.pubDate.toLocaleDateString(lang)}
												</time>
											</div>
										</a>
									))}
								</div>
							</div>
						)
					}

					{
						recentPosts.length > 0 && (
							<div
								class={`px-2 py-2 ${recentTils.length > 0 ? 'mt-4 border-t border-zinc-100 pt-4 dark:border-zinc-800' : ''}`}
							>
								<h3 class="text-xs mb-2 font-semibold uppercase tracking-wider text-zinc-400">
									ğŸ“ Recientes: DevLog
								</h3>
								<div class="space-y-1">
									{recentPosts.map((blogItem) => (
										<a
											href={`/${lang}/blog/${getBaseSlug(blogItem.slug)}/`}
											class="group block rounded-lg px-3 py-2 transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-800"
										>
											<h4 class="text-sm font-medium text-zinc-800 transition-colors group-hover:text-[--tangerine] dark:text-zinc-200 dark:group-hover:text-[--tangerine]">
												{blogItem.data.title}
											</h4>
											<p class="text-xs mt-0.5 line-clamp-1 text-zinc-500 dark:text-zinc-400">
												{blogItem.data.description}
											</p>
										</a>
									))}
								</div>
							</div>
						)
					}

					{
						recentTils.length === 0 && recentPosts.length === 0 && (
							<div class="py-10 text-center text-sm text-zinc-500 dark:text-zinc-400">
								<p>Escribe para buscar artÃ­culos y proyectos...</p>
							</div>
						)
					}
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	const modal = document.getElementById('search-modal')
	const backdrop = document.getElementById('search-backdrop')
	const input = modal?.querySelector('input')
	const resultsContainer = modal?.querySelector('#search-results-container')
	// Store the server-rendered default content
	const defaultContent = resultsContainer?.innerHTML || ''

	let pagefind: any = null

	async function loadPagefind() {
		if (pagefind) return
		try {
			// @ts-ignore
			const url = '/pagefind/pagefind.js'
			pagefind = await import(/* @vite-ignore */ url)
		} catch (e) {
			console.warn('Pagefind not found. Search will only work in production build.')
		}
	}

	function openSearch() {
		modal?.classList.remove('hidden')
		input?.focus()
		loadPagefind()

		// Restore default content if input is empty
		if (input && !input.value.trim() && resultsContainer) {
			resultsContainer.innerHTML = defaultContent
		}
	}

	function closeSearch() {
		modal?.classList.add('hidden')
	}

	async function performSearch(query: string) {
		if (!pagefind || !query.trim()) {
			// Restore default content
			if (resultsContainer) resultsContainer.innerHTML = defaultContent
			return
		}

		const search = await pagefind.search(query)
		const results = await Promise.all(search.results.map((r: any) => r.data()))
		renderResults(results)
	}

	function renderResults(results: any[]) {
		if (!resultsContainer) return

		if (results.length === 0) {
			resultsContainer.innerHTML = `
        <div class="text-center py-10 text-sm text-zinc-500 dark:text-zinc-400">
           ${input?.value ? '<p>No se encontraron resultados.</p>' : '<p>Escribe para buscar artÃ­culos y proyectos...</p>'}
        </div>
      `
			return
		}

		// Categorize results
		const projects = results.filter((r) => r.filters.type?.includes('project'))
		const tils = results.filter((r) => r.filters.type?.includes('til'))
		const articles = results.filter((r) => !r.filters.type || r.filters.type.includes('blog'))

		let html = ''

		if (projects.length > 0) {
			html += `
        <div class="px-2 py-2">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2">ğŸš€ Proyectos</h3>
           <div class="space-y-1">
             ${projects.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (tils.length > 0) {
			html += `
        <div class="px-2 py-2 ${projects.length > 0 ? 'mt-4 border-t border-zinc-100 dark:border-zinc-800 pt-4' : ''}">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2">ğŸ’¡ TIL</h3>
           <div class="space-y-1">
             ${tils.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		if (articles.length > 0) {
			html += `
        <div class="px-2 py-2 ${projects.length > 0 || tils.length > 0 ? 'mt-4 border-t border-zinc-100 dark:border-zinc-800 pt-4' : ''}">
           <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2">ğŸ“ DevLog</h3>
           <div class="space-y-1">
             ${articles.map((r: any) => renderItem(r)).join('')}
           </div>
        </div>
      `
		}

		resultsContainer.innerHTML = html
	}

	function renderItem(item: any) {
		return `
      <a href="${item.url}" class="block px-3 py-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors group">
        <h4 class="text-sm font-medium text-zinc-800 dark:text-zinc-200 group-hover:text-[--tangerine] dark:group-hover:text-[--tangerine] transition-colors">
          ${item.meta.title}
        </h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400 line-clamp-1 mt-0.5">${item.excerpt}</p>
      </a>
    `
	}

	// Debounce search
	let timeout: any
	input?.addEventListener('input', (e) => {
		const val = (e.target as HTMLInputElement).value
		clearTimeout(timeout)
		timeout = setTimeout(() => {
			performSearch(val)
		}, 300)
	})

	// Event Listeners being handled by the Nav button (setup there) or global events
	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			closeSearch()
		}
	})

	backdrop?.addEventListener('click', closeSearch)

	// Close on click outside (wrapper)
	const wrapper = modal?.querySelector('.fixed.z-10')
	wrapper?.addEventListener('click', (e) => {
		if (e.target === wrapper) {
			closeSearch()
		}
	})

	// Custom event to open search from anywhere
	document.addEventListener('open-search', openSearch)
</script>
