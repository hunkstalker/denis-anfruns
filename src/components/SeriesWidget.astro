---
import { getCollection } from 'astro:content';
import { getLangFromSlug, getBaseSlug, type SupportedLang } from '../utils/blogI18n';

interface Props {
  seriesId: string;
  currentSlug: string;
  lang?: SupportedLang;
}

const { seriesId, currentSlug, lang = 'es' } = Astro.props;

// Fetch all posts that belong to this series AND match the current language
const allPosts = await getCollection('blog');
const seriesPosts = allPosts
  .filter((post) => post.data.series === seriesId && getLangFromSlug(post.slug) === lang)
  .sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());

// If less than 2 posts, usually not worth showing a "series" widget, or maybe just "Related"
if (seriesPosts.length < 2) return null;

// Determine base path for links based on lang
const getPath = (slug: string) => lang === 'es' ? `/blog/${getBaseSlug(slug)}/` : `/${lang}/blog/${getBaseSlug(slug)}/`;
---

<div class="series-widget">
  <h3 class="font-bold text-xs uppercase tracking-widest text-zinc-400 dark:text-zinc-500 mb-4">
    Serie: <span class="text-[--tangerine]">{seriesId}</span>
  </h3>

  <ul class="space-y-2 relative">
    <!-- Connecting line -->
    <div class="absolute left-[11px] top-2 bottom-2 w-0.5 bg-zinc-200 dark:bg-zinc-800 -z-10"></div>

    {seriesPosts.map((post, index) => {
      const isCurrent = post.slug === currentSlug;
      return (
        <li class="relative pl-8 group">
          <!-- Status Indicator (Radio/Check) -->
          <!-- Adjusted top to top-1 for better vertical center with text-sm leading-tight -->
          <div 
            class="series-status absolute left-0 top-0.5 w-6 h-6 rounded-full border-2 border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-950 flex items-center justify-center transition-all shadow-sm z-10"
            data-slug={post.slug}
          >
            <!-- Checkmark icon -->
            <svg class="check-icon w-3.5 h-3.5 text-white opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            <!-- Current Dot (visible if current) -->
            {isCurrent && <div class="current-dot absolute w-2 h-2 rounded-full bg-[--tangerine]"></div>}
          </div>

          <a 
            href={getPath(post.slug)}
            class={`block text-sm leading-tight py-1 transition-colors ${
              isCurrent 
                ? 'font-bold text-zinc-900 dark:text-white' 
                : 'text-zinc-600 dark:text-zinc-400 hover:text-[--tangerine]'
            }`}
          >
            {post.data.title}
            {post.data.new && (
                <span class="new-badge ml-2 inline-flex items-center rounded-md bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10 dark:bg-blue-400/10 dark:text-blue-400 dark:ring-blue-400/20">NEW</span>
            )}
          </a>
        </li>
      );
    })}
  </ul>
</div>

<script define:vars={{ currentSlug }}>
  // Logic to handle read status
  function updateReadStatus() {
    const STORAGE_KEY = 'blog:read-posts';
    
    // 1. Get history
    let readPosts = [];
    try {
      readPosts = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch (e) {
      console.error('Error reading localStorage', e);
    }

    // 2. Mark current as read if not already
    if (!readPosts.includes(currentSlug)) {
      readPosts.push(currentSlug);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(readPosts));
    }

    // 3. Update UI
    const indicators = document.querySelectorAll('.series-status');
    indicators.forEach((el) => {
      const slug = el.getAttribute('data-slug');
      const isCurrent = el.querySelector('.current-dot') !== null;
      
      // Handle Read Status Visuals
      if (readPosts.includes(slug)) {
        // If read, hide the NEW badge
        const badge = el.parentElement?.querySelector('.new-badge');
        if (badge) badge.classList.add('hidden');

        // Green Check Logic (Only if not current)
        if (!isCurrent) {
            el.classList.add('bg-green-500', 'border-green-500', 'dark:border-green-500');
            el.querySelector('.check-icon')?.classList.remove('opacity-0');
        }
      }
    });
  }
  
  // Run immediately
  updateReadStatus();
  
  // Also run on Astro View Transitions navigation
  document.addEventListener('astro:page-load', updateReadStatus);
</script>
