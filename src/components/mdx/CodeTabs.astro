---
import { getHighlighterInstance } from '@utils/highlighter'
import copyIconSvg from '@icons/copy.svg?raw'
import checkIconSvg from '@icons/check.svg?raw'

interface TabItem {
	label: string
	code: string
	lang?: string
}

interface Props {
	items: TabItem[]
	status?: 'default' | 'success' | 'error'
	hideTabs?: boolean // true = hide tabs bar, default = show tabs
}

const { items, status = 'default', hideTabs = false } = Astro.props

// Show tabs by default, hide only if explicitly set
const displayTabs = !hideTabs

import { useTranslations } from '@i18n/utils'

import type { Lang } from '@i18n/ui'

const lang = Astro.currentLocale || 'es'
const t = useTranslations(lang as Lang)
const copyLabel = t('code.copy')
const copiedLabel = t('code.copied')

const uniqueId = 'code-tabs-' + Math.random().toString(36).substring(2, 9)

const highlighter = await getHighlighterInstance()
const commonClasses = '!m-0 min-h-[4rem] !rounded-none p-4 text-sm leading-relaxed md:text-base'

const highlightedItems = await Promise.all(
	items.map(async item => {
		const lang = item.lang || 'text'

		const generateHtml = (theme: string) => {
			try {
				return highlighter.codeToHtml(item.code, {
					lang,
					theme,
					transformers: [
						{
							pre(node) {
								if (
									typeof node === 'object' &&
									node &&
									'properties' in node &&
									typeof node.properties === 'object' &&
									node.properties
								) {
									// Safe access after check
									node.properties.class =
										(node.properties.class || '') + ' ' + commonClasses + ' astro-code'
								}
							},
						},
					],
				})
			} catch (_e) {
				// Fallback to text if lang is not loaded
				return highlighter.codeToHtml(item.code, {
					lang: 'text',
					theme,
					transformers: [
						{
							pre(node) {
								if (
									typeof node === 'object' &&
									node &&
									'properties' in node &&
									typeof node.properties === 'object' &&
									node.properties
								) {
									// Safe access after check
									node.properties.class =
										(node.properties.class || '') + ' ' + commonClasses + ' astro-code'
								}
							},
						},
					],
				})
			}
		}

		return {
			...item,
			htmlLight: generateHtml('github-light'),
			htmlDark: generateHtml('github-dark'),
		}
	})
)

const statusClasses = {
	default: 'border-zinc-200 dark:border-zinc-800',
	success: 'border-green-300 dark:border-green-900',
	error: 'border-red-300 dark:border-red-900',
}
---

<div
	id={uniqueId}
	class={`code-tabs-container my-6 overflow-hidden rounded-lg border-2 bg-zinc-100 dark:bg-zinc-900 ${statusClasses[status]}`}>
	<!-- Pestañas de código (solo si hay más de un item o showTabs=true) -->
	{displayTabs && (
		<div
			class='flex items-center justify-between rounded-t-lg border-b border-zinc-200 bg-zinc-50 px-2 pt-2 dark:border-zinc-800 dark:bg-zinc-900/50'>
			<div class='scrollbar-none flex flex-1 items-center overflow-x-auto' role='tablist'>
				{
					items.map((item, index) => (
						<button
							role='tab'
							aria-selected={index === 0 ? 'true' : 'false'}
							aria-controls={`${uniqueId}-panel-${index}`}
							data-index={index}
							data-lang={item.lang}
							class:list={[
								'tab-button mr-1 whitespace-nowrap rounded-t-lg border-x border-t px-4 py-2 text-sm font-medium',
								index === 0
									? 'active border-zinc-200 border-b-white bg-white text-zinc-900 dark:border-zinc-800 dark:border-b-zinc-900 dark:bg-zinc-900 dark:text-zinc-100'
									: 'border-transparent bg-transparent text-zinc-500 hover:bg-zinc-100 hover:text-zinc-700 dark:text-zinc-400 dark:hover:bg-zinc-800 dark:hover:text-zinc-200',
							]}>
							{item.label}
						</button>
					))
				}
			</div>
			<div class='shrink-0 pb-2 pl-4 pr-2'>
				<span class='text-xs lang-label select-none font-mono text-zinc-400 dark:text-zinc-500'>
					{items[0].lang}
				</span>
			</div>
		</div>
	)}

	<!-- Botón de copia de código -->
	<div class='group relative'>
		<div class='absolute right-2 top-2 z-10 opacity-0 transition-opacity group-hover:opacity-100'>
			<button
				class='copy-button cursor-pointer rounded-md bg-zinc-200/50 p-1.5 text-zinc-500 backdrop-blur-sm transition-all hover:bg-zinc-200 hover:text-zinc-700 dark:bg-white/10 dark:text-white/70 dark:hover:bg-white/20 dark:hover:text-white'
				title={copyLabel}
				aria-label={copyLabel}
				data-label-copy={copyLabel}
				data-label-copied={copiedLabel}>
				<span class='copy-icon flex items-center justify-center [&>svg]:size-4'>
					<Fragment set:html={copyIconSvg} />
				</span>
				<span class='check-icon items-center justify-center [&>svg]:size-4' style='display: none;'>
					<Fragment set:html={checkIconSvg} />
				</span>
			</button>
		</div>

		{
			highlightedItems.map((item, index) => (
				<div
					id={`${uniqueId}-panel-${index}`}
					role='tabpanel'
					class:list={['tab-panel bg-white dark:bg-zinc-900', { hidden: index !== 0 }]}>
					<div class='block dark:hidden' set:html={item.htmlLight} />
					<div class='hidden dark:block' set:html={item.htmlDark} />
				</div>
			))
		}
	</div>
</div>

<style is:global>
	.astro-code {
		overflow-x: auto !important;
		background-color: transparent !important;
	}
</style>

<script>
	function initCodeTabs(container: Element) {
		const tabs = container.querySelectorAll('.tab-button')
		const panels = container.querySelectorAll('.tab-panel')
		const copyBtn = container.querySelector('.copy-button')

		const langLabel = container.querySelector('.lang-label')

		// TAB SWITCHING
		tabs.forEach(tab => {
			tab.addEventListener('click', () => {
				const index = Number(tab.getAttribute('data-index'))
				const lang = tab.getAttribute('data-lang')

				// Actualización de pestañas
				tabs.forEach(t => {
					t.setAttribute('aria-selected', 'false')
					t.classList.remove(
						'active',
						'bg-white',
						'dark:bg-zinc-900',
						'text-zinc-900',
						'dark:text-zinc-100',
						'border-zinc-200',
						'dark:border-zinc-800',
						'border-b-white',
						'dark:border-b-zinc-900'
					)
					t.classList.add(
						'bg-transparent',
						'text-zinc-500',
						'hover:text-zinc-700',
						'dark:text-zinc-400',
						'dark:hover:text-zinc-200',
						'border-transparent',
						'hover:bg-zinc-100',
						'dark:hover:bg-zinc-800'
					)
				})

				tab.setAttribute('aria-selected', 'true')
				tab.classList.remove(
					'bg-transparent',
					'text-zinc-500',
					'hover:text-zinc-700',
					'dark:text-zinc-400',
					'dark:hover:text-zinc-200',
					'border-transparent',
					'hover:bg-zinc-100',
					'dark:hover:bg-zinc-800'
				)
				tab.classList.add(
					'active',
					'bg-white',
					'dark:bg-zinc-900',
					'text-zinc-900',
					'dark:text-zinc-100',
					'border-zinc-200',
					'dark:border-zinc-800',
					'border-b-white',
					'dark:border-b-zinc-900'
				)

				// Actualización de etiqueta de idioma
				if (langLabel && lang) {
					langLabel.textContent = lang
				}

				// Actualización de paneles
				panels.forEach((p, i) => {
					if (i === index) {
						p.classList.remove('hidden')
					} else {
						p.classList.add('hidden')
					}
				})
			})
		})

		// Funcionalidad de copiar
		copyBtn?.addEventListener('click', async () => {
			// Buscar el panel visible
			const visiblePanel = Array.from(panels).find(p => !p.classList.contains('hidden'))
			if (!visiblePanel) return

			// Buscar el bloque de código visible dentro del panel (ya que ahora hay dos: light y dark)
			// Usamos offsetParent para verificar visibilidad, o window.getComputedStyle
			const codeElements = visiblePanel.querySelectorAll('code')
			let code = ''

			for (const codeEl of codeElements) {
				if (codeEl.offsetParent !== null) {
					code = codeEl.innerText
					break
				}
			}

			if (!code) return

			try {
				await navigator.clipboard.writeText(code)

				// Alternar iconos para feedback
				const copyIcon = copyBtn.querySelector('.copy-icon')
				const checkIcon = copyBtn.querySelector('.check-icon')

				const labelCopy = copyBtn.getAttribute('data-label-copy') || 'Copy code'
				const labelCopied = copyBtn.getAttribute('data-label-copied') || 'Copied!'

				if (copyIcon instanceof HTMLElement) copyIcon.style.display = 'none'
				if (checkIcon instanceof HTMLElement) {
					checkIcon.style.display = 'flex'
					checkIcon.classList.add('text-green-500')
				}

				copyBtn.setAttribute('title', labelCopied)
				copyBtn.setAttribute('aria-label', labelCopied)

				setTimeout(() => {
					if (copyIcon instanceof HTMLElement) copyIcon.style.display = 'flex'
					if (checkIcon instanceof HTMLElement) {
						checkIcon.style.display = 'none'
						checkIcon.classList.remove('text-green-500')
					}

					copyBtn.setAttribute('title', labelCopy)
					copyBtn.setAttribute('aria-label', labelCopy)
				}, 2000)
			} catch (err) {
				console.error('Failed to copy', err)
			}
		})
	}

	// Inicializar todas las instancias presentes y futuras (Astro View Transitions compatible)
	document.addEventListener('astro:page-load', () => {
		document.querySelectorAll('.code-tabs-container').forEach(initCodeTabs)
	})

	// Also run on initial load if not using view transitions or for first paint
	document.querySelectorAll('.code-tabs-container').forEach(initCodeTabs)
</script>
