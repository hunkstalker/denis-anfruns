---
// Importación de componentes UI
import Button from '@components/ui/Button.astro'
import ThemeToggle from '@components/ui/ThemeToggle.astro'
import LanguagePicker from '@components/ui/LanguagePicker.astro'
import MenuToggle from './MenuToggle'
import MobileMenu from './MobileMenu'
import NavDropdown from './NavDropdown'
import Search from '@components/search/Search.astro'
import SearchResults from '@components/search/SearchResults.astro'

import { useTranslations } from '@i18n/utils'
import { navItems } from '@i18n/navigation'

// Importación de Iconos

import SearchIcon from '@icons/search.svg'
import PlaygroundIcon from '@icons/playground.svg'

// Definición de las Props
interface Props {
	lang?: 'es' | 'en' | 'ca'
}

// Extracción de props y configuración de traducciones
const { lang = 'es' } = Astro.props
// Importación de componentes UI
import SearchBadges from 'astro-search-badges/src/SearchBadges.astro'
import { ui } from '@i18n/ui'

const t = useTranslations(lang)

// Configuración de Filtros para el Buscador
const filters = {
	notes: {
		keys: ['notes'],
		label: 'blog.notes',
		badge: 'NOTES',
		color: 'emerald',
		filterType: 'notes',
	},
	projects: {
		keys: { es: 'proyectos', en: 'projects', ca: 'projectes' },
		label: 'nav.search.filter.projects',
		badge: 'PRO',
		color: 'blue',
		filterType: 'project',
	},
	devlog: {
		keys: ['devlog'],
		label: 'blog.series',
		badge: 'DEV',
		color: 'purple',
		filterType: 'devlog',
	},
}

// Pasar traducciones completas
const translations = ui

// Obtener ruta actual para resaltar el menú activo
const currentPath = Astro.url.pathname

const getLocalizedPath = (path: string) =>
	lang === 'es' ? path : `/${lang}${path === '/' ? '' : path}`

const menuItems = navItems.map(item => {
	const finalPath = getLocalizedPath(item.path)
	const isActive =
		currentPath === finalPath || (item.path !== '/' && currentPath.startsWith(finalPath))

	const children = item.children?.map(child => {
		const childPath = getLocalizedPath(child.path)
		const isChildActive =
			currentPath === childPath || (child.path !== '/' && currentPath.startsWith(childPath))
		return {
			label: t(child.key),
			link: childPath,
			active: isChildActive,
			enabled: child.enabled,
		}
	})

	return {
		label: t(item.key),
		link: finalPath,
		active: isActive,
		enabled: item.enabled,
		children,
		i18nKey: item.key, // For dynamic translation on 404
	}
})
---

<nav
	class='fixed inset-x-0 top-0 z-50 border-b border-zinc-200/50 bg-[#f8f6f3]/80 backdrop-blur-md shadow-sm dark:border-zinc-700/50 dark:bg-zinc-900/70'>
	<div class='container'>
		<div class='flex items-center justify-between py-4 md:py-6'>
			<!-- Menú Hamburguesa (Móvil) & Menu Portal -->
			<div class='sm:hidden'>
				<MenuToggle client:load label={t('nav.menu')} />
				<MobileMenu client:load items={menuItems} lang={lang} />
			</div>

			<!-- Menú de Navegación Desktop (Enlaces) -->
			<div class='hidden shrink-0 sm:inline-flex md:gap-1'>
				<ul class='flex items-center space-x-1'>
					{
						menuItems
							.filter(item => item.enabled)
							.map(item => (
								<li>
									{item.children ? (
										<NavDropdown
											label={item.label}
											link={item.link}
											items={item.children}
											active={item.active}
											enabled={item.enabled}
											client:load
										/>
									) : (
										<Button
											text={item.label}
											link={item.link}
											enabled={item.enabled}
											active={item.active}
											class='w-auto'
											i18nKey={item.i18nKey}
										/>
									)}
								</li>
							))
					}
					{/* Secret Playground Link */}
					<li id='nav-playground-item' class='hidden'>
						<Button
							text='PLAYGROUND'
							link='/playground'
							class='flex w-auto items-center justify-center gap-2 !text-emerald-600 transition-colors hover:!bg-emerald-500/10 dark:!text-emerald-400 dark:hover:!bg-emerald-400/10'>
							PLAYGROUND
							<PlaygroundIcon class='size-5' />
						</Button>
					</li>
				</ul>
			</div>

			<script>
				// Check if user has unlocked the playground
				const hasAccess = localStorage.getItem('playground_access') === 'granted'
				const navItem = document.getElementById('nav-playground-item')
				if (hasAccess && navItem) {
					navItem.classList.remove('hidden')
				}
			</script>

			<!-- Zona Derecha (Buscador, Idioma, Tema) -->
			<div class='flex items-center gap-4 md:gap-6'>
				<!-- Botón Lupa (Solo Móvil) -->
				<button
					id='search-mobile-btn'
					class='mr-3 text-zinc-500 transition-colors hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 md:hidden'
					aria-label={t('nav.search.label')}>
					<SearchIcon class='size-5' />
				</button>

				<!-- Barra de Búsqueda (Solo Desktop) - Estilo Híbrido -->
				<div
					class='group/search relative hidden w-48 shrink transition-all duration-300 md:block lg:w-72 xl:w-96'>
					<div class='relative w-full'>
						<span
							class='pointer-events-none absolute inset-y-0 left-0 z-10 flex items-center pl-3 text-zinc-500 dark:text-zinc-400'>
							<SearchIcon class='size-4' />
						</span>

						<SearchBadges
							filters={filters}
							lang={lang}
							translations={translations}
							placeholder={t('nav.search') || 'Buscar...'}
							width='w-full'
							focusRingClass='focus:ring-[--tangerine]'
							badgePadding='5.5rem'
						/>
					</div>

					<!-- Mega-Dropdown de Resultados (Hybrid Overlay) -->
					<!-- Overlay de fondo -->
					<div
						id='desktop-search-overlay'
						class='fixed inset-x-0 top-[calc(100%+1px)] z-40 hidden h-screen bg-zinc-900/20 opacity-0'>
					</div>

					<!-- Panel de Resultados (Mega-Dropdown) -->
					<div
						id='desktop-search-results'
						class='invisible fixed inset-x-0 top-24 z-50 mx-auto max-w-6xl origin-top -translate-y-4 overflow-hidden rounded-2xl border border-stone-300/50 bg-stone-100 opacity-0 shadow-2xl transition-all duration-300 ease-out dark:border-white/10 dark:bg-zinc-900'>
						<!-- Contenido Unificado -->
						<div class='w-full'>
							<SearchResults
								lang={lang}
								mode='desktop'
								inputId='search-badges-input'
								resultsContainerId='desktop-unified-results'
							/>
						</div>
					</div>
				</div>

				<LanguagePicker />
				<ThemeToggle lang={lang} />
			</div>
		</div>
	</div>
</nav>

<Search lang={lang} />

<script>
	import { ui, defaultLang } from '@i18n/ui'

	// Lógica para abrir el buscador desde el botón móvil
	const searchMobileBtn = document.getElementById('search-mobile-btn')
	searchMobileBtn?.addEventListener('click', () => {
		document.dispatchEvent(new CustomEvent('open-search'))
	})

	// Detección de SO para mostrar Command (Mac) o Ctrl (Windows)
	const shortcutKey = document.getElementById('shortcut-key')
	if (shortcutKey) {
		const isMac = navigator.userAgent.includes('Mac')
		if (!isMac) {
			shortcutKey.textContent = 'Ctrl K'
		}
	}

	// === Lógica de Búsqueda Desktop Híbrida ===
	// El ID viene del componente SearchBadges
	const desktopInput = document.getElementById('search-badges-input') as HTMLInputElement
	const resultsContainer = document.getElementById('desktop-search-results')
	const resultsOverlay = document.getElementById('desktop-search-overlay')

	let isOpen = false

	// Función para mostrar resultados/overlay
	function showResults() {
		if (resultsContainer && resultsOverlay) {
			resultsOverlay.classList.remove('hidden')
			// Forzar reflow para animación
			void resultsOverlay.offsetWidth
			resultsOverlay.classList.remove('opacity-0')

			resultsContainer.classList.remove('invisible', '-translate-y-4', 'opacity-0')
			document.body.classList.add('overflow-hidden') // Lock scroll
			isOpen = true
		}
	}

	// Función para ocultar resultados/overlay
	function hideResults() {
		if (resultsContainer && resultsOverlay) {
			resultsOverlay.classList.add('opacity-0')
			resultsContainer.classList.add('-translate-y-4', 'opacity-0')
			document.body.classList.remove('overflow-hidden') // Unlock scroll

			setTimeout(() => {
				resultsOverlay.classList.add('hidden')
				resultsContainer.classList.add('invisible')
			}, 200)
			isOpen = false
		}
	}

	// Toggle basado en foco
	desktopInput?.addEventListener('focus', () => {
		showResults()
		// loadNavPagefind() -> Ahora lo hace UnifiedSearchResults
	})

	// Cerrar al hacer clic fuera (Estrategia Global Robust)
	document.addEventListener('click', (e) => {
		if (!isOpen) return // Si está cerrado, no hacemos nada

		const target = e.target as Node
		const isClickInside = 
			(desktopInput && desktopInput.contains(target)) || 
			(resultsContainer && resultsContainer.contains(target))

		if (!isClickInside) {
			hideResults()
		}
	})

	// Debounce y Listeners
	// Event Listeners para el Componente SearchBadges (Desktop UI Logic: Placeholder etc)

	// Helper to get current lang (respects localStorage on 404 page)
	const getLangForPlaceholder = (): keyof typeof ui => {
		const is404 = document.getElementById('error-title') !== null
		if (is404) {
			const saved = localStorage.getItem('selectedLang') as keyof typeof ui | null
			if (saved && saved in ui) return saved
		}
		const docLang = document.documentElement.lang as keyof typeof ui
		return docLang in ui ? docLang : defaultLang
	}

	if (desktopInput) {
		// Cuando se crea un badge
		desktopInput.addEventListener('badgeCreated', ev => {
			const { config } = ev.detail
			const label = config?.label

			// FORZAR LIMPIEZA DEL INPUT desde el controlador padre también
			desktopInput.value = ''

			// RESTAURAR LÓGICA DE PLACEHOLDER Y PADDING
			const currentLang = getLangForPlaceholder()
			const t = ui[currentLang]
			const translatedLabel = t[label as keyof typeof t] || label

			// Usar claves exactas de i18n/ui.ts
			const search = t['nav.search'] || 'Buscar...'
			const searchIn = t['nav.search.in'] || 'en'

			desktopInput.placeholder = `${search} ${searchIn} ${translatedLabel}...`

			// showFilteredInitialContent(filterType) -> Ahora lo hace UnifiedSearchResults
		})

		// Cuando se borra un badge
		desktopInput.addEventListener('badgeRemoved', () => {
			// RESTAURAR LÓGICA DE PLACEHOLDER Y PADDING ORIGINAL
			const currentLang = getLangForPlaceholder()
			const t = ui[currentLang]
			desktopInput.placeholder = t['nav.search'] || 'Buscar...'
			desktopInput.style.paddingLeft = '2.5rem'

			// showFilteredInitialContent(null) -> Ahora lo hace UnifiedSearchResults
			// if (desktopInput.value.trim()) searchNav(desktopInput.value) -> Ahora lo hace UnifiedSearchResults
		})
	}

	// Teclas Globales
	document.addEventListener('keydown', e => {
		if (e.key === 'Escape') {
			if (isOpen) {
				desktopInput?.blur()
				hideResults()
				// Limpiar badges y sugerencias al cerrar
			}
		}
		if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
			e.preventDefault()
			desktopInput?.focus()
			// showResults se activa por el evento 'focus' del input
		}
	})

	// === 404 Page Language Sync ===
	// On 404 page, sync Nav texts with localStorage lang
	const is404Page = document.getElementById('error-title') !== null
	if (is404Page) {
		const savedLang = (localStorage.getItem('selectedLang') || 'es') as keyof typeof ui
		const translations = ui[savedLang] || ui[defaultLang]

		// Update all elements with data-i18n attribute
		document.querySelectorAll('[data-i18n]').forEach(el => {
			const key = el.getAttribute('data-i18n') as keyof typeof translations
			if (key && translations[key]) {
				el.textContent = translations[key]
			}
		})

		// Update search input placeholders
		const searchPlaceholder = translations['nav.search'] || 'Buscar...'
		const desktopSearchInput = document.getElementById(
			'search-badges-input',
		) as HTMLInputElement | null
		const mobileSearchInput = document.getElementById(
			'mobile-search-input',
		) as HTMLInputElement | null

		if (desktopSearchInput) desktopSearchInput.placeholder = searchPlaceholder
		if (mobileSearchInput) mobileSearchInput.placeholder = searchPlaceholder
	}
</script>

<style>
	/* Donde se incluya el nav se apliará el padding-top al body para dar espacio */
	:global(body) {
		padding-top: 4rem;
	}
</style>
