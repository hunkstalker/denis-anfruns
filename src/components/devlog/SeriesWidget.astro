---
import { getDevlogs, type DevlogPost } from '../../utils/devlog-content'
import { getLangFromSlug, getBaseSlug, type SupportedLang } from '../../utils/blogi18n'
import CheckIcon from '../../icons/check.svg'
import { Badge } from '../ui/Badge'

interface Props {
	seriesId: string
	currentSlug: string
	lang?: SupportedLang
}

const badgetText = {
	es: { 'b.new': 'NUEVO' },
	ca: { 'b.new': 'NOU' },
	en: { 'b.new': 'NEW' },
}

const { seriesId, currentSlug, lang = 'es' } = Astro.props

const allDevlogs = await getDevlogs()
const seriesPosts = allDevlogs
	.filter(post => post.data.series === seriesId && getLangFromSlug(post.slug) === lang)
	.sort((a: DevlogPost, b: DevlogPost) => {
		if (!a.data.pubDate || !b.data.pubDate) {
			return 0
		}
		return a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
	})

if (seriesPosts.length === 0) return null
const isSinglePostFinished = seriesPosts.length === 1 && seriesPosts[0].data.end
if (isSinglePostFinished) return null

const getPath = (slug: string) =>
	lang === 'es' ? `/devlog/${getBaseSlug(slug)}/` : `/${lang}/devlog/${getBaseSlug(slug)}/`
---

<div class='series-widget'>
	<h3 class='text-xs mb-4 flex items-center gap-2 font-bold uppercase tracking-widest text-zinc-400 dark:text-zinc-500'>
		Serie: 
		<span class="text-[--tangerine-hover] normal-case tracking-normal font-medium">
			{seriesId}
		</span>
	</h3>

	<ul class='relative space-y-2'>
		{
			seriesPosts.map((post: DevlogPost, index: number) => {
				const isCurrent = post.slug === currentSlug
				const isLast = index === seriesPosts.length - 1
				const showDashedTail = isLast && !post.data.end

				return (
					<li class='group relative pl-8'>
						{/* Connecting Line */}
						{!isLast && (
							<div class='absolute left-[11px] top-[14px] -z-10 h-full w-0.5 bg-zinc-200 dark:bg-zinc-800' />
						)}

						{/* Dashed Tail for incomplete series */}
						{showDashedTail && (
							<div class='absolute left-[11px] top-[14px] -z-10 h-8 w-0.5 border-l-2 border-dashed border-zinc-200 dark:border-zinc-800' />
						)}

						<div
							class='series-status absolute left-0 top-0.5 z-10 flex size-6 items-center justify-center rounded-full border-2 border-zinc-300 bg-white shadow-sm transition-all dark:border-zinc-600 dark:bg-zinc-950'
							data-slug={post.slug}>
							<CheckIcon class='check-icon size-3.5 text-white opacity-0 transition-opacity' />
							{isCurrent && (
								<div class='current-dot absolute size-2 rounded-full bg-[--tangerine]' />
							)}
						</div>

						<a
							href={getPath(post.slug)}
							data-astro-prefetch
							class={`flex items-start py-1 text-sm leading-tight transition-colors ${
								isCurrent
									? 'font-bold text-zinc-900 dark:text-white'
									: 'text-zinc-600 hover:text-[--tangerine-hover] dark:text-zinc-400'
							}`}>
							{post.data.seriesTitle || post.data.title}
							{post.data.new && (
								<Badge variant='subtle' className='new-badge ml-2 uppercase tracking-wider'>
									{badgetText[lang]['b.new']}
								</Badge>
							)}
						</a>
					</li>
				)
			})
		}
	</ul>
</div>

<script is:inline define:vars={{ currentSlug }}>
	function updateReadStatus() {
		const STORAGE_KEY = 'blog:read-posts'

		let readPosts = []
		try {
			readPosts = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')
		} catch (e) {
			console.error('Error reading localStorage', e)
		}

		const indicators = document.querySelectorAll('.series-status')
		indicators.forEach(el => {
			const slug = el.getAttribute('data-slug')
			const isCurrent = el.querySelector('.current-dot') !== null

			if (readPosts.includes(slug)) {
				const badge = el.parentElement?.querySelector('.new-badge')
				if (badge) badge.classList.add('hidden')

				if (!isCurrent) {
					el.classList.add('bg-green-500', 'border-green-500', 'dark:border-green-500')
					el.querySelector('.check-icon')?.classList.remove('opacity-0')
				}
			}
		})
	}

	updateReadStatus()

	window.addEventListener('read-status-changed', updateReadStatus)
	document.addEventListener('astro:page-load', updateReadStatus)
</script>
