---
import type { MarkdownHeading } from 'astro'
import { useTranslations } from '../../i18n/utils'
import type { SupportedLang } from '../../utils/blogi18n'
import ListIcon from '../../icons/list.svg'

interface Props {
	headings: MarkdownHeading[]
	lang?: SupportedLang
}

const { headings, lang = 'es' } = Astro.props
const t = useTranslations(lang)

const toc = headings.filter((h) => h.depth > 1 && h.depth <= 3)
---

{
	toc.length > 0 && (
		<nav class="toc-container max-h-[calc(100vh-10rem)] overflow-y-auto pr-4 text-sm">
			<h3 class="text-xs mb-4 flex items-center gap-2 px-3 font-bold uppercase tracking-widest text-zinc-400 dark:text-zinc-500">
				<ListIcon class="size-3.5" />
				{t('blog.tableOfContents')}
			</h3>
			<ul class="space-y-1">
				{toc.map((heading) => {
                    // Remove emojis using modern Unicode property escapes
                    // \p{Extended_Pictographic} covers most emojis
                    // /g flag for global, /u flag for unicode
                    const cleanText = heading.text.replace(/[\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\u{200D}]+/gu, '').trim()
                    
                    return (
					<a
						href={`#${heading.slug}`}
						class={`block py-1.5 text-zinc-500 no-underline hover:text-blue-600 dark:text-zinc-400 dark:hover:text-blue-400 ${heading.depth === 2 ? 'pl-4' : 'text-xs pl-8'} `}
					>
						{cleanText}
					</a>
				    )
                })}
			</ul>
		</nav>
	)
}

<script>
	const observer = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			const id = entry.target.getAttribute('id')
			if (entry.intersectionRatio > 0) {
				document.querySelectorAll('nav.toc-container a').forEach((link) => {
					link.classList.remove(
						'text-blue-600',
						'font-medium',
						'border-l-2',
						'border-blue-500',
						'-ml-0.5',
					)
				})
				const activeLink = document.querySelector(`nav.toc-container a[href="#${id}"]`)
				if (activeLink) {
					activeLink.classList.add('text-blue-600', 'dark:text-blue-400', 'font-medium')
				}
			}
		})
	})

	document.querySelectorAll('article h2, article h3').forEach((h) => {
		observer.observe(h)
	})
</script>
