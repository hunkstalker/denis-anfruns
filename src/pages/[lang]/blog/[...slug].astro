---
import { type CollectionEntry, getCollection } from 'astro:content'
import BaseLayout from '../../../layouts/BaseLayout.astro'
import Nav from '../../../components/Nav.astro'
import TableOfContents from '../../../components/TableOfContents.astro'
import SeriesWidget from '../../../components/SeriesWidget.astro'
import SeriesGithubCard from '../../../components/SeriesGithubCard.astro'
import { getLangFromSlug, getBaseSlug } from '../../../utils/blogi18n'
import { useTranslations } from '../../../i18n/utils'
import { languages } from '../../../i18n/ui'

import ChevronUp from '../../../icons/chevron-up.svg'
import ChevronRight from '../../../icons/chevron-right.svg'
import ChevronLeft from '../../../icons/chevron-left.svg'

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true
	})
	const supportedLangs = Object.keys(languages).filter((lang) => lang !== 'es')

	return posts
		.filter((post) => supportedLangs.includes(getLangFromSlug(post.slug)))
		.map((post) => {
			const lang = getLangFromSlug(post.slug)
			return {
				params: {
					lang: lang,
					slug: getBaseSlug(post.slug),
				},
				props: post,
			}
		})
}

type Props = CollectionEntry<'blog'>

const post = Astro.props
const lang = getLangFromSlug(post.slug)
const t = useTranslations(lang)
const { Content, headings } = await post.render()

let nextPost: CollectionEntry<'blog'> | null = null
if (post.data.series) {
	const allPosts = await getCollection('blog', ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true
	})
	const seriesPosts = allPosts
		.filter((p) => p.data.series === post.data.series && getLangFromSlug(p.slug) === lang)
		.sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf())
	const currentIndex = seriesPosts.findIndex((p) => p.slug === post.slug)
	nextPost = seriesPosts[currentIndex + 1] || null
}
---

<BaseLayout
	siteTitle={post.data.title}
	lang={lang}
	description={post.data.description}
	image={post.data.ogImage ?? post.data.heroImage}
>
	<Nav lang={lang} />

	<div class="container mx-auto px-4 py-8 pt-20 md:pt-28">
		<div class="grid grid-cols-1 gap-8 lg:grid-cols-12 lg:gap-12">
			<article
				class="prose max-w-none dark:prose-invert lg:prose-xl lg:col-span-8 xl:col-span-9"
				data-pagefind-body
				data-pagefind-filter={`type:${post.data.tags.some((t) => t.toLowerCase() === 'project') ? 'project' : 'blog'}`}
				data-pagefind-meta={`description:${post.data.description}`}
			>
				<div class="not-prose mb-8">
					{
						post.data.heroImage && (
							<div class="mb-6">
								<img
									src={post.data.heroImage}
									alt={post.data.title}
									class="h-auto max-h-[400px] w-full rounded-lg object-cover"
								/>
								{post.data.descriptionHeroImage && (
									<p class="mt-2 text-sm italic text-zinc-500">{post.data.descriptionHeroImage}</p>
								)}
							</div>
						)
					}

					<div class="mb-4 flex flex-wrap items-center gap-4 font-mono text-sm text-zinc-500">
						<time datetime={post.data.pubDate.toISOString()}>
							{
								post.data.pubDate.toLocaleString(lang, {
									year: 'numeric',
									month: 'short',
									day: 'numeric',
									hour: '2-digit',
									minute: '2-digit',
								})
							} (CET)
						</time>
						{
							post.data.updatedDate && (
								<>
									<span>/</span>
									<span class="text-zinc-500">
										{t('blog.updated')}:{' '}
										{post.data.updatedDate.toLocaleString(lang, {
											year: 'numeric',
											month: 'short',
											day: 'numeric',
											hour: '2-digit',
											minute: '2-digit',
										})}{' '}
										(CET)
									</span>
								</>
							)
						}
					</div>

					<h1
						class="mb-6 text-balance text-3xl font-bold leading-tight dark:text-white md:text-5xl"
					>
						{post.data.title}
					</h1>

					<div class="flex flex-wrap gap-2">
						{
							post.data.tags.map((tag) => (
								<span class="rounded-md border border-zinc-200 bg-zinc-100 px-2.5 py-1 text-sm font-medium text-zinc-600 dark:border-zinc-700/50 dark:bg-zinc-800 dark:text-zinc-400">
									#{tag}
								</span>
							))
						}
					</div>
					<hr class="mt-8 border-zinc-200 dark:border-zinc-800" />
				</div>

				<!-- Mobile Table of Contents (Collapsible) -->
				<details
					class="mb-8 rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-800 dark:bg-zinc-900/50 lg:hidden"
				>
					<summary
						class="flex cursor-pointer items-center gap-2 font-medium text-zinc-900 dark:text-zinc-100"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="h-5 w-5 text-zinc-500"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"
							></line><line x1="8" y1="18" x2="21" y2="18"></line><line
								x1="3"
								y1="6"
								x2="3.01"
								y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line
								x1="3"
								y1="18"
								x2="3.01"
								y2="18"></line></svg
						>
						{t('toc.title') || 'Table of Contents'}
					</summary>
					<div class="mt-4 border-t border-zinc-200 pt-4 dark:border-zinc-700">
						<TableOfContents headings={headings} lang={lang} />
					</div>
				</details>

				{
					post.data.series && (
						<div class="mb-8 lg:hidden">
							<SeriesGithubCard seriesId={post.data.series} lang={lang} />
						</div>
					)
				}

				<Content />

				<footer class="not-prose mt-16 border-t border-zinc-200 pt-8 dark:border-zinc-700">
					<div class="flex items-center justify-between">
						<button
							id="scroll-to-top"
							class="group flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-[--tangerine]"
						>
							<ChevronUp class="transition-transform group-hover:-translate-y-0.5" />
							{t('blog.backToTop')}
						</button>

						{
							nextPost && (
								<a
									href={`/${lang}/blog/${getBaseSlug(nextPost.slug)}/`}
									class="group flex items-center gap-2 text-sm font-medium text-zinc-500 no-underline transition-colors hover:text-[--tangerine]"
								>
									{t('blog.nextPost')}
									<ChevronRight class="transition-transform group-hover:translate-x-1" />
								</a>
							)
						}
					</div>
				</footer>

				<script>
					document.getElementById('scroll-to-top')?.addEventListener('click', () => {
						window.scrollTo({ top: 0, behavior: 'smooth' })
					})
				</script>
			</article>

			<!-- Columna derecha de Widgets -->
			<aside class="hidden lg:col-span-4 lg:block xl:col-span-3">
				<div class="sticky top-32 space-y-8">
					{
						post.data.series && (
							<SeriesWidget seriesId={post.data.series} currentSlug={post.slug} lang={lang} />
						)
					}

					<TableOfContents headings={headings} lang={lang} />

					{post.data.series && <SeriesGithubCard seriesId={post.data.series} lang={lang} />}

					<div class="mt-8 border-t border-zinc-100 pt-8 dark:border-zinc-800">
						<a
							href={`/${lang}/blog`}
							class="flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-zinc-900 dark:hover:text-[--tangerine]"
						>
							<ChevronLeft />
							{t('blog.backToBlog')}
						</a>
					</div>
				</div>
			</aside>
		</div>
	</div>

	<div class="h-16 md:h-24"></div>
</BaseLayout>
