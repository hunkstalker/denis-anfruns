---
import ContentLayout from '../../../layouts/ContentLayout.astro'
import BackLink from '../../../components/ui/BackLink.astro'
import { getDevlogs, type DevlogPost } from '../../../utils/devlog-content'
import { getLangFromSlug } from '../../../utils/blogi18n'
import { useTranslations } from '../../../i18n/utils'
import DevLogGrid from '../../../components/devlog/Grid'

export function getStaticPaths() {
	return [{ params: { lang: 'en' } }, { params: { lang: 'ca' } }]
}

const { lang } = Astro.params
const t = useTranslations(lang as 'en' | 'ca')

// Obtener y filtrar posts
const rawPosts = (await getDevlogs()).filter(
	(p) => getLangFromSlug(p.slug) === lang && p.data.pubDate,
)

// Lógica de Agrupación por Series
const seriesMap = new Map<string, DevlogPost[]>()
const soloPosts: DevlogPost[] = []

for (const post of rawPosts) {
	if (post.data.series) {
		const list = seriesMap.get(post.data.series) || []
		list.push(post)
		seriesMap.set(post.data.series, list)
	} else {
		soloPosts.push(post)
	}
}

// Procesar series (mismo lógica que index principal)
const finalSeriesPosts = Array.from(seriesMap.values()).map((list) => {
	list.sort((a: DevlogPost, b: DevlogPost) => {
		if (!a.data.pubDate || !b.data.pubDate) return 0
		return a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
	})

	const part1 = list[0]
	const latestPart = list[list.length - 1]

	const entry = {
		...part1,
		data: {
			...part1.data,
			pubDate: latestPart.data.pubDate,
		},
	}
	return entry
})

const articles = [...soloPosts, ...finalSeriesPosts].sort((a, b) => {
	if (!a.data.pubDate || !b.data.pubDate) return 0
	return b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
})
---

<ContentLayout
	title={t('blog.series')}
	siteTitle={`DevLogs - ${t('site.title')}`}
	lang={lang as 'en' | 'ca'}
>
	<div class="lg:col-span-12">
		<div class="mb-8">
			<BackLink href={`/${lang}/blog`} label={t('blog.backToBlog')} />

			<h1 class="mb-6 flex items-center gap-2 text-3xl font-bold dark:text-zinc-200">DevLogs</h1>

			<p class="text-lg text-zinc-500">{t('blog.devLogDescription')}</p>
			<hr class="animate-fade-in-up mt-8 border-zinc-200 dark:border-zinc-800" />
		</div>

		{
			articles.length === 0 ? (
				<p class="italic text-zinc-500">{t('blog.withoutArticles')}</p>
			) : (
				<DevLogGrid
					client:load
					posts={articles}
					lang={lang as 'en' | 'ca'}
					labels={{ readArticle: t('blog.readArticle') }}
				/>
			)
		}
	</div>
</ContentLayout>
