---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Nav from '../../components/Nav.astro';
import { languages } from '../../i18n/ui';
import { getLangFromSlug, getBaseSlug, type SupportedLang } from '../../utils/blogI18n';

export async function getStaticPaths() {
  return Object.keys(languages)
    .filter(lang => lang !== 'es')
    .map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const rawPosts = (await getCollection('blog')).filter(p => getLangFromSlug(p.slug) === lang);

// Logic to consolidate series
// Map series name -> Array of posts in that series
const seriesMap = new Map<string, CollectionEntry<'blog'>[]>();
const soloPosts: CollectionEntry<'blog'>[] = [];

for (const post of rawPosts) {
    if (post.data.series) {
        const list = seriesMap.get(post.data.series) || [];
        list.push(post);
        seriesMap.set(post.data.series, list);
    } else {
        soloPosts.push(post);
    }
}

// Process series:
// 1. Sort posts by date within series.
// 2. Pick the FIRST post (Part 1, oldest) to display.
// 3. Use the LAST post's date (Newest) for sorting the feed.
const finalSeriesPosts = Array.from(seriesMap.values()).map(list => {
    // Sort ascending (Oldest -> Newest)
    list.sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());
    
    const part1 = list[0]; 
    const latestPart = list[list.length - 1]; 
    
    const entry = { 
        ...part1, 
        data: { 
            ...part1.data, 
            pubDate: latestPart.data.pubDate
        } 
    };
    return entry;
});

const allPosts = [...soloPosts, ...finalSeriesPosts].sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const tils = allPosts.filter(post => post.data.tags.includes('til') || post.data.tags.includes('snippet'));
const articles = allPosts.filter(post => !post.data.tags.includes('til') && !post.data.tags.includes('snippet'));
---

<BaseLayout siteTitle="Jard√≠n Digital" lang={lang}>
  <Nav lang={lang as 'es' | 'en' | 'ca'} />
  <div class="container mx-auto px-4 py-8 pt-20 md:pt-28">
    
    <div class="mb-12 text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 dark:text-white">Jard√≠n Digital</h1>
      <p class="text-xl text-zinc-600 dark:text-zinc-400 max-w-2xl mx-auto">
        Un espacio donde documento mi aprendizaje. Desde art√≠culos profundos hasta peque√±os fragmentos de c√≥digo (TILs).
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
      
      <!-- Main Column: Articles -->
      <div class="lg:col-span-8 space-y-12">
        <h2 class="text-2xl font-bold border-b border-zinc-200 dark:border-zinc-700 pb-2 mb-6 flex items-center gap-2 dark:text-zinc-200">
          <span>üåø</span> Art√≠culos
        </h2>
        
        {articles.length === 0 && <p class="text-zinc-500 italic">No hay art√≠culos todav√≠a.</p>}

        <div class="grid gap-8">
          {articles.map((post) => (
            <article class="group relative flex flex-col md:flex-row gap-6 bg-white dark:bg-zinc-800/50 p-6 rounded-2xl border border-zinc-200 dark:border-zinc-700/50 hover:border-blue-500/50 transition-all shadow-sm hover:shadow-md">
              <div class="flex-1">
                <div class="flex items-center gap-3 text-xs text-zinc-500 mb-3">
                  <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}
                  </time>
                  <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded-full font-medium">
                    {post.data.tags[0]}
                  </span>
                </div>
                
                <h3 class="text-xl font-bold mb-2 dark:text-white group-hover:text-blue-500 transition-colors">
                  <a href={`/${lang}/blog/${getBaseSlug(post.slug)}/`}>
                    <span class="absolute inset-0"></span>
                    {post.data.title}
                  </a>
                </h3>
                
                <p class="text-zinc-600 dark:text-zinc-400 line-clamp-2 mb-4">
                  {post.data.description}
                </p>

                <div class="flex items-center gap-2 text-sm font-medium text-blue-600 dark:text-blue-400">
                  Leer art√≠culo 
                  <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>

      <!-- Sidebar: TILs -->
      <aside class="lg:col-span-4 space-y-8">
        <div class="bg-zinc-50 dark:bg-zinc-900/50 p-6 rounded-xl border border-zinc-200 dark:border-zinc-800 sticky top-24">
          <h2 class="text-xl font-bold border-b border-zinc-200 dark:border-zinc-700 pb-2 mb-6 flex items-center gap-2 dark:text-zinc-200">
            <span>üå±</span> Today I Learned
          </h2>

          <div class="space-y-4">
            {tils.length === 0 && <p class="text-zinc-500 italic text-sm">No hay TILs todav√≠a.</p>}

            {tils.map((post) => (
              <a href={`/${lang}/blog/${getBaseSlug(post.slug)}/`} class="block group p-4 rounded-lg bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 hover:border-green-500/50 transition-colors">
                <div class="flex items-start justify-between gap-2 mb-1">
                  <span class="text-xs font-mono text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-1.5 py-0.5 rounded">
                    TIL
                  </span>
                  <time class="text-xs text-zinc-400" datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric'})}
                  </time>
                </div>
                <h3 class="font-medium text-zinc-800 dark:text-zinc-200 group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors leading-tight">
                  {post.data.title}
                </h3>
              </a>
            ))}
          </div>
          
          <div class="mt-6 pt-6 border-t border-zinc-200 dark:border-zinc-700 text-center">
            <p class="text-sm text-zinc-500">
              Peque√±os fragmentos de conocimiento que voy recolectando d√≠a a d√≠a.
            </p>
          </div>
        </div>
      </aside>

    </div>
  </div>
</BaseLayout>