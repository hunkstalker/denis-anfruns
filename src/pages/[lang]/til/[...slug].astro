---
import { getTils, type TilPost } from '../../../utils/til-content'
import ContentLayout from '../../../layouts/ContentLayout.astro'
import BackLink from '../../../components/ui/BackLink.astro'
import ChevronUp from '../../../icons/chevron-up.svg'
import ChevronRight from '../../../icons/chevron-right.svg'
import { languages } from '../../../i18n/ui'
import { useTranslations } from '../../../i18n/utils'
import SeriesWidget from '../../../components/common/SeriesWidget.astro'
import TableOfContents from '../../../components/devlog/TableOfContents.astro'
import MarkAsRead from '../../../components/common/MarkAsRead.astro'

export async function getStaticPaths() {
	const allPosts = await getTils()
	const posts = allPosts.filter(post => {
		return import.meta.env.PROD ? post.data.draft !== true : true
	})
	const supportedLangs = Object.keys(languages).filter(lang => lang !== 'es')

	return posts
		.filter(post => supportedLangs.includes(post.data.lang))
		.map(post => {
			return {
				params: {
					lang: post.data.lang,
					// Strip the language suffix (e.g. /en or /ca) relative to the language
					// This assumes the slug ends with the language code
					slug: post.slug.replace(new RegExp(`/${post.data.lang}$`), ''),
				},
				props: post,
			}
		})
}

type Props = TilPost

const post = Astro.props
const { Content, headings } = await post.render()
const { lang } = Astro.params
const t = useTranslations(lang)
const siteTitle = `TIL: ${post.data.title}`

// Calculate next post in series
let nextPost: TilPost | null = null
if (post.data.series) {
	const allPosts = await getTils()
	const seriesPosts = allPosts
		.filter(p => p.data.series === post.data.series && p.data.lang === lang)
		.sort((a, b) => {
			if (!a.data.pubDate || !b.data.pubDate) return 0
			return a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
		})
	const currentIndex = seriesPosts.findIndex(p => p.slug === post.slug)
	nextPost = seriesPosts[currentIndex + 1] || null
}
---

<style>
	.animate-fade-in-up {
		opacity: 0;
		animation: fadeInUp 0.8s ease-out forwards;
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}
	.delay-300 {
		animation-delay: 0.3s;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>

<ContentLayout
	siteTitle={siteTitle}
	title={post.data.title}
	lang={lang}
	description={post.data.title}>
	<MarkAsRead slug={post.slug} collection='til' />
	{/* Conditional Layout */}
	<div
		class={post.data.series || headings.length > 0
			? 'col-span-1 lg:col-span-8'
			: 'lg:col-span-8 lg:col-start-3'}>
		<div class='mb-8'>
			<BackLink href={`/${lang}/blog`} label={t('blog.backToBlog')} />

			<h1
				class='animate-fade-in-up mb-6 text-3xl font-bold leading-tight delay-100 dark:text-zinc-200 md:text-4xl'>
				{post.data.title}
			</h1>

			{/* ... */}
		</div>

		{/* ... */}
	</div>

	{/* Desktop Sidebar Widget */}
	{
		(post.data.series || headings.length > 0) && (
			<aside class='hidden lg:col-span-4 lg:block'>
				<div class='sticky top-32 space-y-8'>
					{post.data.series && (
						<div class='mb-8 lg:hidden'>
							<SeriesWidget 
								seriesId={post.data.series} 
								currentSlug={post.slug} 
								lang={lang} 
								collection='til'
								id='mobile-series'
							/>
						</div>
					)}
					{post.data.series && (
						<SeriesWidget 
							seriesId={post.data.series} 
							currentSlug={post.slug} 
							lang={lang} 
							collection='til'
							id='desktop-series'
						/>
					)}
					{headings.length > 0 && <TableOfContents headings={headings} lang={lang} />}
				</div>
			</aside>
		)
	}
</ContentLayout>

<script>
	document.getElementById('scroll-to-top')?.addEventListener('click', () => {
		window.scrollTo({ top: 0, behavior: 'smooth' })
	})
</script>
