---
import { getTils, type TilPost } from '../../../utils/til-content'
import ContentLayout from '../../../layouts/ContentLayout.astro'
import BackLink from '../../../components/ui/BackLink.astro'
import ChevronUp from '../../../icons/chevron-up.svg'
import { languages } from '../../../i18n/ui'
import { useTranslations } from '../../../i18n/utils'
import SeriesWidget from '../../../components/til/SeriesWidget.astro'

export async function getStaticPaths() {
	const allPosts = await getTils()
	const posts = allPosts.filter((post) => {
		return import.meta.env.PROD ? post.data.draft !== true : true
	})
	const supportedLangs = Object.keys(languages).filter((lang) => lang !== 'es')

	return posts
		.filter((post) => supportedLangs.includes(post.data.lang))
		.map((post) => {
			return {
				params: {
					lang: post.data.lang,
					// Strip the language suffix (e.g. /en or /ca) relative to the language
                    // This assumes the slug ends with the language code
					slug: post.slug.replace(new RegExp(`/${post.data.lang}$`), ''),
				},
				props: post,
			}
		})
}

type Props = TilPost

const post = Astro.props
const { Content } = await post.render()
const { lang } = Astro.params
const t = useTranslations(lang)
const siteTitle = `TIL: ${post.data.title}`
---

<style>
	.animate-fade-in-up {
		opacity: 0;
		animation: fadeInUp 0.8s ease-out forwards;
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}
	.delay-300 {
		animation-delay: 0.3s;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>

<ContentLayout
	siteTitle={siteTitle}
	title={post.data.title}
	lang={lang}
	description={post.data.title}
>
    {/* Conditional Layout */}
	<div class={post.data.series ? 'col-span-1 lg:col-span-8 xl:col-span-9' : 'lg:col-span-8 lg:col-start-3'}>
		<div class="mb-8">
			<BackLink href={`/${lang}/blog`} label={t('blog.backToBlog')} />

			<h1
				class="animate-fade-in-up mb-6 text-3xl font-bold leading-tight delay-100 dark:text-zinc-200 md:text-4xl"
			>
				{post.data.title}
			</h1>

			<div
				class="animate-fade-in-up flex flex-wrap gap-4 font-mono text-sm text-zinc-500 delay-200"
			>
				<time datetime={post.data.pubDate!.toISOString()}>
					{post.data.pubDate!.toLocaleDateString(lang, { dateStyle: 'long' })}
				</time>
				<div class="flex gap-2">
					{(post.data.tags || []).map((tag) => <span>#{tag}</span>)}
				</div>
			</div>

			<hr class="animate-fade-in-up mt-8 border-zinc-200 delay-300 dark:border-zinc-800" />
		</div>

        {/* Mobile Series Widget */}
        {
            post.data.series && (
                <div class="mb-8 lg:hidden">
                    <SeriesWidget seriesId={post.data.series} currentSlug={post.slug} lang={lang} />
                </div>
            )
        }

		<article
			class="prose prose-lg max-w-none dark:prose-invert"
			data-pagefind-body
			data-pagefind-filter="type:til"
		>
			<Content />
		</article>

		<div class="mt-12 border-t border-zinc-200 pt-8 dark:border-zinc-800">
			<button
				id="scroll-to-top"
				class="group inline-flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-zinc-900 dark:hover:text-[--tangerine]"
			>
				<ChevronUp class="transition-transform group-hover:-translate-y-0.5" />
				{t('blog.backToTop')}
			</button>
		</div>

		<div class="h-24"></div>
	</div>

    {/* Desktop Sidebar Widget */}
    {
        post.data.series && (
            <aside class="hidden lg:col-span-4 lg:block xl:col-span-3">
                <div class="sticky top-32 space-y-8">
                    <SeriesWidget seriesId={post.data.series} currentSlug={post.slug} lang={lang} />
                </div>
            </aside>
        )
    }
</ContentLayout>

<script>
	document.getElementById('scroll-to-top')?.addEventListener('click', () => {
		window.scrollTo({ top: 0, behavior: 'smooth' })
	})
</script>
