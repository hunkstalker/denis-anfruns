---
import { type CollectionEntry } from 'astro:content'
import { getTils, type TilPost } from '../../../utils/til-content'
import BaseLayout from '../../../layouts/BaseLayout.astro'
import Nav from '../../../components/Nav.astro'
import ChevronLeft from '../../../icons/chevron-left.svg'
import { languages } from '../../../i18n/ui'
import { useTranslations } from '../../../i18n/utils'

export async function getStaticPaths() {
	const allPosts = await getTils()
	const posts = allPosts.filter(post => {
		return import.meta.env.PROD ? post.data.draft !== true : true
	})
	const supportedLangs = Object.keys(languages).filter((lang) => lang !== 'es')

	return posts
		.filter((post) => supportedLangs.includes(post.data.lang))
		.map((post) => {
			// slug is "folder/lang" -> we want "folder" as the URL slug
			const slug = post.slug.split('/')[0]
			return {
				params: {
					lang: post.data.lang,
					slug: slug,
				},
				props: post,
			}
		})
}
type Props = TilPost

const post = Astro.props
const { Content } = await post.render()
const { lang } = Astro.params
const t = useTranslations(lang)
---

<style>
	.animate-fade-in-up {
		opacity: 0;
		animation: fadeInUp 0.8s ease-out forwards;
	}

	.delay-100 { animation-delay: 0.1s; }
	.delay-200 { animation-delay: 0.2s; }
	.delay-300 { animation-delay: 0.3s; }

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>

<BaseLayout siteTitle={`TIL: ${post.data.title}`} lang={lang} description={post.data.title}>
	<Nav lang={lang} />

	<div class="container mx-auto px-4 py-8 pt-20 md:pt-28">
		<div class="mx-auto max-w-3xl">
			<div class="mb-8">
				<a
					href={`/${lang}/blog`}
					class="animate-fade-in-up mb-6 inline-flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-zinc-900 dark:hover:text-[--tangerine]"
				>
					<ChevronLeft />
					{t('blog.backToBlog')}
				</a>

				<h1 class="animate-fade-in-up delay-100 mb-4 text-3xl font-bold leading-tight dark:text-white md:text-4xl">
					{post.data.title}
				</h1>

				<div
					class="animate-fade-in-up delay-200 flex gap-3 border-b border-zinc-200 pb-6 font-mono text-sm text-zinc-500 dark:border-zinc-800"
				>
					<time datetime={post.data.pubDate!.toISOString()}>
						{post.data.pubDate!.toLocaleDateString(lang, { dateStyle: 'long' })}
					</time>
					<span>/</span>
					<div class="flex gap-2">
						{post.data.tags.map((tag) => <span>#{tag}</span>)}
					</div>
				</div>
			</div>

			<article
				class="prose prose-lg max-w-none dark:prose-invert"
				data-pagefind-body
				data-pagefind-filter="type:til"
			>
				<Content />
			</article>

			<div class="mt-12 border-t border-zinc-200 pt-8 dark:border-zinc-800">
				<a
					href={`/${lang}/blog`}
					class="inline-flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors hover:text-zinc-900 dark:hover:text-[--tangerine]"
				>
					<ChevronLeft />
					{t('blog.backToBlog')}
				</a>
			</div>

			<div class="h-24"></div>
		</div>
	</div>
</BaseLayout>
