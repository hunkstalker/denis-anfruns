---
import ContentLayout from '@layouts/ContentLayout.astro'
import BackLink from '@components/ui/BackLink.astro'
import { getTils } from '@utils/til-content'
import { useTranslations } from '@i18n/utils'
import { languages } from '@i18n/ui'
import type { SupportedLang } from '@utils/blogi18n'
import Grid from '@components/til/Grid'

export async function getStaticPaths() {
	return Object.keys(languages)
		.filter((lang) => lang !== 'es')
		.map((lang) => ({ params: { lang: lang as SupportedLang } }))
}

const { lang } = Astro.params
const t = useTranslations(lang as SupportedLang)

const tilCollection = await getTils()

// Lógica de Agrupación por Series
const seriesMap = new Map<string, typeof tilCollection>()
const soloPosts: typeof tilCollection = []

for (const post of tilCollection) {
    // Filtrar solo los del idioma actual y válidos
    if (post.data.lang !== lang || !post.data.pubDate || (import.meta.env.PROD && post.data.draft === true)) continue;

	if (post.data.series) {
		const list = seriesMap.get(post.data.series) || []
		list.push(post)
		seriesMap.set(post.data.series, list)
	} else {
		soloPosts.push(post)
	}
}

// Procesar series
const finalSeriesPosts = Array.from(seriesMap.values()).map((list) => {
	list.sort((a, b) => {
		return a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
	})

	const part1 = list[0]
	const latestPart = list[list.length - 1]

    // Check if ANY part in the series is marked as new
    const hasNewContent = list.some(p => p.data.new)

	const entry = {
		...part1,
		data: {
			...part1.data,
			pubDate: latestPart.data.pubDate,
            new: hasNewContent
		},
	}
	return entry
})

// Unificar y ordenar todo
const tils = [...soloPosts, ...finalSeriesPosts].sort((a, b) => {
	return b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
})
---

<ContentLayout
	title={t('blog.til')}
	siteTitle={`TIL - ${t('blog.til')}`}
	lang={lang as SupportedLang}
>
	<div class="lg:col-span-12">
		<div class="mb-8">
			<BackLink href={lang === 'es' ? '/blog' : `/${lang}/blog`} label={t('blog.backToBlog')} />

			<h1 class="mb-6 flex items-center gap-2 text-3xl font-bold dark:text-zinc-200">
				{t('blog.til')}
			</h1>

			<p class="text-lg text-zinc-500">{t('blog.tilDescription')}</p>
			<hr class="animate-fade-in-up mt-8 border-stone-400 dark:border-zinc-800" />
		</div>

		<Grid
			client:load
			posts={tils}
			lang={lang as SupportedLang}
			labels={{
				all: t('search.all'),
				noResults: t('blog.withoutTILs'),
				readNote: t('blog.readNote'),
			}}
		/>
	</div>
</ContentLayout>
