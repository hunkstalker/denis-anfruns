---
import { getNotes, type NotePost } from '@utils/notes-content'
import ContentLayout from '@layouts/ContentLayout.astro'
import BackLink from '@components/ui/BackLink.astro'
import ChevronUp from '@icons/chevron-up.svg'
import ChevronRight from '@icons/chevron-right.svg'
import { useTranslations } from '@i18n/utils'
import MarkAsRead from '@components/common/MarkAsRead.astro'

export async function getStaticPaths() {
	const allPosts = await getNotes()
	const posts = allPosts.filter(post => {
		return import.meta.env.PROD ? post.data.draft !== true : true
	})
	return posts
		.filter(post => post.data.lang === 'es')
		.map(post => ({
			// Fix: Use full slug, don't split.
			// If the file is es.mdx, slug ends in /es. Remove it for the URL.
			params: { slug: post.slug.replace(/\/es$/, '') },
			props: post,
		}))
}
type Props = NotePost

const post = Astro.props
const { Content, headings } = await post.render()
const lang = 'es'
const siteTitle = `Note: ${post.data.title}`
const t = useTranslations(lang)

// Calculate next post in series
let nextPost: NotePost | null = null
if (post.data.series) {
	const allPosts = await getNotes()
	const seriesPosts = allPosts
		.filter(p => p.data.series === post.data.series && p.data.lang === 'es')
		.sort((a, b) => {
			if (!a.data.pubDate || !b.data.pubDate) return 0
			return a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
		})
	const currentIndex = seriesPosts.findIndex(p => p.slug === post.slug)
	nextPost = seriesPosts[currentIndex + 1] || null
}
---

<style>
	.animate-fade-in-up {
		opacity: 0;
		animation: fadeInUp 0.8s ease-out forwards;
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}
	.delay-300 {
		animation-delay: 0.3s;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>

<ContentLayout
	siteTitle={siteTitle}
	title={post.data.title}
	lang={lang}
	description={post.data.title}
	isWide={!!post.data.series}>
	{/* Activate wide mode if series exists */}
	<MarkAsRead slug={post.slug} collection='notes' />
	{/* Conditional Layout: Full width if no series/toc, Sidebar otherwise */}
	<div class='lg:col-span-8 lg:col-start-3'>
		<div class='mb-8'>
			<BackLink href={lang === 'es' ? '/blog' : `/${lang}/blog`} label={t('blog.back')} />

			<h1 class='animate-fade-in-up mb-6 text-3xl font-bold leading-tight delay-100 dark:text-zinc-200 
				md:text-4xl'>
				{post.data.title}
			</h1>

			<div class='animate-fade-in-up flex flex-wrap gap-4 font-mono text-sm text-zinc-500 delay-200'>
				<time datetime={post.data.pubDate!.toISOString()}>
					{post.data.pubDate!.toLocaleDateString('es-ES', { dateStyle: 'long' })}
				</time>
				<div class='flex gap-2'>
					{(post.data.tags || []).map(tag => <span>#{tag}</span>)}
				</div>
			</div>

			<hr class='animate-fade-in-up mt-8 border-stone-400 delay-300 dark:border-zinc-800' />
		</div>

		<article
			class='prose prose-lg max-w-none dark:prose-invert'
			data-pagefind-body
			data-pagefind-filter='type:notes'
			data-pagefind-meta={`description:${post.data.description || ''}, series:${post.data.series || ''}, 
				seriesTitle:${post.data.seriesTitle || ''}, seriesDescription:${post.data.seriesDescription || ''}`}>
			{/* Hidden content for Pagefind indexing - allows search with highlighting */}
			{
				(post.data.seriesTitle || post.data.seriesDescription) && (
					<span class='sr-only' data-pagefind-weight='2'>
						{post.data.seriesTitle}
						{post.data.seriesTitle && post.data.seriesDescription ? ' Â· ' : ''}
						{post.data.seriesDescription}
					</span>
				)
			}
			<Content />
		</article>

		<footer class='mt-12 border-t border-zinc-200 pt-8 dark:border-zinc-800'>
			<div class='flex items-center justify-between'>
				<button
					id='scroll-to-top'
					class='group inline-flex items-center gap-2 text-sm font-medium text-zinc-500 transition-colors 
						hover:text-[--tangerine-hover] dark:hover:text-[--tangerine]'>
					<ChevronUp class='transition-transform group-hover:-translate-y-0.5' />
					Volver arriba
				</button>

				{
					nextPost && (
						<a
							href={`/notes/${nextPost.slug.replace(/\/es$/, '')}/`}
							class='group flex items-center gap-2 text-sm font-medium text-zinc-500 no-underline 
								transition-colors hover:text-[--tangerine-hover] dark:hover:text-[--tangerine]'>
							Siguiente
							<ChevronRight class='transition-transform group-hover:translate-x-1' />
						</a>
					)
				}
			</div>
		</footer>

		<div class='h-24'></div>
	</div>
</ContentLayout>

<script>
	document.getElementById('scroll-to-top')?.addEventListener('click', () => {
		window.scrollTo({ top: 0, behavior: 'smooth' })
	})
</script>
