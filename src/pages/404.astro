---
import BaseLayout from '../layouts/BaseLayout.astro'
import Nav from '../components/layout/Nav.astro'
const siteTitle = 'Denis Anfruns - Error 404'
---

<BaseLayout siteTitle={siteTitle}>
	<Nav />

	<main
		id="main-content"
		class="relative flex min-h-[60vh] grow flex-col items-center justify-center overflow-hidden transition-opacity duration-500"
	>
		<!-- Giant 404 Background -->
		<div
			class="pointer-events-none absolute inset-0 flex select-none items-center justify-center"
			aria-hidden="true"
		>
			<span
				class="text-[10rem] font-black leading-none text-zinc-200/50 dark:text-zinc-800/50 sm:text-[20rem] md:text-[28rem] lg:text-[36rem]"
			>
				404
			</span>
		</div>

		<!-- Foreground Content -->
		<div class="relative z-10 px-4 text-center">
			<h1
				id="error-title"
				class="animate-fade-in-up md:text-6xl mx-auto max-w-2xl text-balance text-4xl font-black leading-tight tracking-tight sm:text-5xl"
			>
			</h1>
			<p
				id="error-msg"
				class="animate-fade-in-up text-lg mx-auto mt-6 max-w-lg text-balance text-zinc-500 delay-100 dark:text-zinc-400"
			>
			</p>
		</div>
	</main>

	<!-- Terminal Overlay - Always Visible -->
	<div
		id="terminal-overlay"
		class="pointer-events-none fixed inset-0 z-50 hidden overflow-hidden font-mono text-zinc-900 dark:text-white md:block"
	>
		<!-- Left-aligned terminal window -->
		<div
			class="absolute left-0 top-0 flex size-full flex-col justify-end p-4 pb-32 md:w-1/2 md:p-8 md:pb-8 lg:w-1/3"
		>
			<div
				id="terminal-logs"
				class="text-xs mask-image-fade flex max-h-[50vh] flex-col gap-1 overflow-hidden font-bold tracking-wider md:max-h-full md:text-sm"
			>
				<div id="command-line" class="flex items-center">
					<span class="mr-2">&gt;</span>
					<span id="type-target"></span>
					<span class="animate-blink-retro">_</span>
				</div>
			</div>
		</div>
	</div>
</BaseLayout>

<style>
	.animate-fade-in-up {
		opacity: 0;
		animation: fadeInUp 0.8s ease-out forwards;
	}

	.delay-100 {
		animation-delay: 0.1s;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-blink-retro {
		animation: blinkRetro 1s step-end infinite;
	}

	@keyframes blinkRetro {
		0%,
		100% {
			opacity: 1;
		}
		50% {
			opacity: 0;
		}
	}

	.mask-image-fade {
		mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
		-webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
	}
</style>

<script>
	const translations = {
		es: {
			title: 'Página no encontrada',
			msg: 'Parece que te has perdido por internet. Si quieres visitar mi sitio web, explora la barra de navegación.',
		},
		ca: {
			title: 'Pàgina no trobada',
			msg: "Sembla que t'has perdut a Internet. Si vols visitar el meu lloc web, explora la barra de navegació.",
		},
		en: {
			title: 'Page not found',
			msg: "It seems you've lost your way on the internet. If you want to visit my website, explore the navigation bar.",
		},
	}

	// ============================================================
	// COMMANDS REGISTRY - Add new commands here!
	// Each command defines: logs, barSize, duration, redirect, and optional hooks
	// ============================================================

	type Command = {
		logs: string[]
		barSize?: number // Default: 30
		duration?: number // Duration in ms (default: 1000)
		logDelay?: number // Delay between logs in ms (default: 0)
		redirect: 'home' | 'about' | string // 'home', 'about', or custom path
		onBeforeRedirect?: () => void // Optional hook before redirect
	}

	const commands: Record<string, Command> = {
		// Another World / Out of This World Easter Egg
		'RUN PROJECT 23': {
			logs: [
				'> SYSTEM_ERROR_404',
				'> INITIALIZING_FERRARI_PROJECT...',
				'> USER: LESTER_CHAYKIN',
				'> ENTER_CODE: L5',
				'> ENTER_ID: K8',
				'> ENTER_PASSWORD: 4511932',
				'> ACCESS_GRANTED',
				'> CHECKING_SYSTEMS...',
				'> MEM............[OK]',
				'> DATA...........[OK]',
				'> BLOCK..........[OK]',
				'> POSIT..........[OK]',
				'> ENERGY_LEVEL: 100%',
				'> SYNCHRO........[ACTIVE]',
				'> PARTICLE_ACCELERATION_STARTED',
				'> ANOMALY_DETECTED_SECTOR_404',
				'> DIMENSIONAL_TEAR_IMMINENT',
				'> INITIATING_TELEPORT_SEQUENCE...',
				'> INITIATING_PROJECT_23...',
				'> CONNECTING_TO_GLOBAL_SKYNET...',
				'> TARGET: HUMANITY... [SKIP]',
				'> SYSTEM_ERROR: YOU_DIDNT_SAY_THE_MAGIC_WORD',
				'> ACCESS_DENIED',
				'> SECTOR: THE_SWAN',
				'> ENTERING_SEQUENCE:',
				'> 4 8 15 16 23 42',
				'> EXECUTE_STATION_PEARL',
				'> ANOMALY_DETECTED: ELECTROMAGNETIC_DISCHARGE',
				'> DIMENSIONAL_COLLAPSE_IMMINENT',
				'> WAKE_UP_NEO...',
				'> THE_MATRIX_HAS_YOU...',
				'> FOLLOWING_THE_WHITE_RABBIT...',
				'> REBOOTING_REALITY...',
			],
			redirect: 'home',
		},

		// ABOUT Easter Egg - Activates all hover effects on About page
		ABOUT: {
			logs: [
				'> ACCESSING_PERSONNEL_DATABASE...',
				'> USER_PROFILE: DENIS_ANFRUNS MILLÁN',
				'> LOADING_FULL_SPECTRUM_VIEW...',
				'> ACTIVATING_ALL_TECH_SIGNATURES...',
				'> DISPLAY_MODE: RAINBOW',
				'> REDIRECTING_TO_ABOUT...',
			],
			barSize: 50,
			duration: 2500,
			logDelay: 150,
			redirect: 'about',
			onBeforeRedirect: () => {
				localStorage.setItem('about-activate-all', 'true')
			},
		},

		// Secret Playground Access
		// "RUN PLAYGROUND.EXE" hashed (SHA-256)
		dcc5b20bef132083b0f1f6baaa2f5738dcad807e6669ae43d67c9a75e1667a57: {
			logs: [
				'> SYSTEM_OVERRIDE_DETECTED',
				'> DECRYPTING_SECURE_CHANNEL...',
				'> LOADING_DEV_TOOLS_MODULE...',
				'> MOUNTING_VIRTUAL_FILESYSTEM...',
				'> ACCESS_GRANTED: WELCOME_CREATOR',
			],
			barSize: 40,
			duration: 1500,
			logDelay: 100,
			redirect: '/playground',
			onBeforeRedirect: () => {
				localStorage.setItem('playground_access', 'granted')
			},
		},

		// ============================================================
		// ADD MORE COMMANDS HERE! Example:
		// 'MATRIX': {
		//   logs: ['> ENTERING_THE_MATRIX...', '> FOLLOW_THE_WHITE_RABBIT...'],
		//   barSize: 40,
		//   duration: 2000,
		//   redirect: 'home'
		// },
		// ============================================================
	}

	// Generic command executor
	async function executeCommand(cmd: Command, lang: string) {
		if (!terminalLogs) return

		// Type all logs
		for (const log of cmd.logs) {
			await typeLog(log)
			if (cmd.logDelay) {
				await new Promise((r) => setTimeout(r, cmd.logDelay))
			}
		}

		// Show progress bar
		await showProgressBar(cmd.barSize ?? 30, cmd.duration ?? 1000)

		// Run hook before redirect
		if (cmd.onBeforeRedirect) {
			cmd.onBeforeRedirect()
		}

		// Calculate redirect path
		let path: string
		if (cmd.redirect === 'home') {
			path = lang === 'es' ? '/' : `/${lang}`
		} else if (cmd.redirect === 'about') {
			path = lang === 'es' ? '/about/' : `/${lang}/about/`
		} else {
			path = cmd.redirect
		}

		window.location.href = path
	}

	// Helper: Generate SHA-256 hash
	async function sha256(message: string) {
		const msgBuffer = new TextEncoder().encode(message)
		const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer)
		const hashArray = Array.from(new Uint8Array(hashBuffer))
		const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('')
		return hashHex
	}

	// ============================================================
	// CORE SYSTEM - No need to modify below this line
	// ============================================================

	function getLang() {
		const pathLang = window.location.pathname.split('/')[1]
		if (pathLang in translations) return pathLang
		const savedLang = localStorage.getItem('selectedLang')
		if (savedLang && savedLang in translations) return savedLang
		const userLang = navigator.language.split('-')[0]
		if (userLang in translations) return userLang
		return 'es'
	}

	const lang = getLang() as keyof typeof translations
	const t = translations[lang] || translations['es']

	// Text Update
	const titleElement = document.getElementById('error-title')
	const msgElement = document.getElementById('error-msg')

	if (titleElement) titleElement.textContent = t.title
	if (msgElement) msgElement.textContent = t.msg

	const terminalLogs = document.getElementById('terminal-logs')
	const commandLine = document.getElementById('command-line')
	const typeTarget = document.getElementById('type-target')

	// Hidden Form & Input for robust Enter key handling
	const hiddenForm = document.createElement('form')
	hiddenForm.style.cssText = 'position:absolute;opacity:0;top:0;left:0;height:0;overflow:hidden'

	const hiddenInput = document.createElement('input')
	hiddenInput.type = 'text'
	hiddenInput.autocomplete = 'off'
	hiddenInput.style.fontSize = '16px'

	hiddenForm.appendChild(hiddenInput)
	document.body.appendChild(hiddenForm)

	// Focus handling - only focus terminal when clicking outside interactive elements AND on desktop
	document.addEventListener('click', (e) => {
		// Mobile check: Only allow focus if screen is MD or larger
		if (!window.matchMedia('(min-width: 768px)').matches) return

		const target = e.target as HTMLElement
		// Don't steal focus from nav, search, buttons, links, inputs, etc.
		const isInteractive = target.closest('nav, a, button, input, [role="button"], [data-search]')
		if (!isInteractive) {
			hiddenInput.focus()
		}
	})

	// Auto-focus on load (only if not focused on something else AND on desktop)
	if (
		(!document.activeElement || document.activeElement === document.body) &&
		window.matchMedia('(min-width: 768px)').matches
	) {
		hiddenInput.focus()
	}

	if (typeTarget) typeTarget.style.whiteSpace = 'pre'

	let isExecuting = false

	// Helper: Type a log line with cursor effect
	async function typeLog(text: string) {
		if (!terminalLogs) return

		const p = document.createElement('div')
		p.textContent = text
		p.className = 'opacity-0'
		p.style.borderRight = '2px solid transparent'

		// Insert BEFORE command line so the input always stays at the bottom
		if (commandLine && commandLine.parentNode === terminalLogs) {
			terminalLogs.insertBefore(p, commandLine)
		} else {
			terminalLogs.appendChild(p)
		}

		terminalLogs.scrollTop = terminalLogs.scrollHeight

		requestAnimationFrame(() => {
			p.classList.remove('opacity-0')
			p.style.borderRightColor = 'currentColor'
		})

		await new Promise((r) => setTimeout(r, Math.random() * 50 + 20))
		p.style.borderRightColor = 'transparent'
	}

	// Helper: Show ASCII progress bar
	// barSize: width in chars (default 30)
	// durationMs: total duration in ms (default ~1000ms)
	async function showProgressBar(barSize: number = 30, durationMs: number = 1000) {
		if (!terminalLogs) return

		const pBar = document.createElement('div')
		pBar.className = 'mt-4 font-bold whitespace-pre mb-20'

		// Insert BEFORE command line
		if (commandLine && commandLine.parentNode === terminalLogs) {
			terminalLogs.insertBefore(pBar, commandLine)
		} else {
			terminalLogs.appendChild(pBar)
		}

		const totalChars = barSize
		const steps = 50 // Number of updates
		const stepDelay = durationMs / steps

		for (let i = 0; i <= 100; i += 100 / steps) {
			const percent = Math.round(i)
			const filled = Math.round((percent / 100) * totalChars)
			const empty = totalChars - filled
			pBar.textContent = `> LOADING... [${'#'.repeat(filled)}${'.'.repeat(empty)}] ${percent}%`
			terminalLogs.scrollTop = terminalLogs.scrollHeight
			await new Promise((r) => setTimeout(r, stepDelay))
		}

		await new Promise((r) => setTimeout(r, 200))
	}

	// Password Protection State
	let isPasswordMode = false
	const PLAYGROUND_HASH = '8a2266f450423a535981b12c13c39562b59e4ff8f8574a9b3a6d7a8c526b681c' // SHA-256 for "GEMINI"

	// Input handling
	hiddenInput.addEventListener('input', (e) => {
		if (isExecuting) return

		const val = (e.target as HTMLInputElement).value.toUpperCase()
		// Allow A-Z, 0-9, spaces, and dots (for commands like .EXE)
		const cleanVal = val.replace(/[^A-Z0-9 .]/g, '')

		if (val !== cleanVal) hiddenInput.value = cleanVal

		if (typeTarget) {
			if (isPasswordMode) {
				typeTarget.textContent = '*'.repeat(cleanVal.length)
			} else {
				typeTarget.textContent = cleanVal
			}
		}
	})

	// Command execution
	hiddenForm.addEventListener('submit', async (e) => {
		e.preventDefault()
		if (isExecuting) return

		const input = hiddenInput.value.toUpperCase().trim()

		// --- PASSWORD MODE LOGIC ---
		if (isPasswordMode) {
			isExecuting = true
			if (commandLine) commandLine.style.display = 'none'

			// "Double Hash" check (User input -> Hash -> Compare)
			const hash = await sha256(input) // input is UPPERCASE from value, maybe we want case-insensitive?
			// But for "1234" it's same. If we want complex passwords, we might need original case.
			// However current input logic forces UpperCase. let's stick to simple "1234".

			if (hash === PLAYGROUND_HASH) {
				// Success
				await executeCommand(
					{
						logs: [
							'> VERIFYING_HASH...',
							'> ACCESS_GRANTED',
							'> INITIALIZING_ENVIRONMENT...',
							'> WELCOME_ADMINISTRATOR',
						],
						barSize: 40,
						duration: 1500,
						redirect: '/playground',
						onBeforeRedirect: () => {
							localStorage.setItem('playground_access', 'granted')
						},
					},
					lang,
				)
			} else {
				// Failed
				await executeCommand(
					{
						logs: [
							'> VERIFYING_HASH...',
							'> ACCESS_DENIED',
							'> INCORRECT_PASSWORD',
							'> TERMINATING_SESSION...',
						],
						duration: 1000,
						redirect: 'none', // Special case to just reset
					},
					lang,
				)

				// Reset terminal to ready state (hacky via reload or just reset)
				// For now, redirect 'none' will just end. We need to reset UI.
				isPasswordMode = false
				hiddenInput.value = ''
				if (typeTarget) typeTarget.textContent = ''
				if (commandLine) commandLine.style.display = 'flex'
				// Restore cursor
				hiddenInput.focus()
				isExecuting = false

				// Add a new prompt line
				await typeLog('> _')
			}
			return
		}

		// --- NORMAL COMMAND LOGIC ---

		if (input === 'RUN PLAYGROUND.EXE') {
			isExecuting = true
			hiddenInput.blur() // Temporarily blur to stop typing
			if (commandLine) commandLine.style.display = 'none'

			// Log the prompt sequence
			await typeLog('> INITIATING_SECURITY_PROTOCOL...')
			await new Promise((r) => setTimeout(r, 500))
			await typeLog('> ENTER PASSWORD:')

			// Reset for password input
			hiddenInput.value = ''
			if (typeTarget) typeTarget.textContent = ''
			if (commandLine) commandLine.style.display = 'flex'

			isPasswordMode = true
			isExecuting = false
			hiddenInput.focus()
			return
		}

		// Check for direct match (legacy/non-secret commands)
		let command = commands[input]

		// If not found, check hashed commands (legacy fallback)
		if (!command) {
			const hash = await sha256(input)
			command = commands[hash]
		}

		if (command && terminalLogs) {
			isExecuting = true
			hiddenInput.blur()
			if (commandLine) commandLine.style.display = 'none'

			await executeCommand(command, lang)
		} else {
			// Unknown command feedback
			await typeLog(`> UNKNOWN_COMMAND: ${input}`)
			hiddenInput.value = ''
			if (typeTarget) typeTarget.textContent = ''
		}
	})
</script>
